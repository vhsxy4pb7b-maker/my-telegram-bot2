# ç»Ÿè®¡å½•å…¥é‡‘é¢ç¼ºå¤±é—®é¢˜ - ä»£ç åˆ†ææŠ¥å‘Š

## ğŸ” é—®é¢˜åˆ†æ

### æ‰§è¡Œé¡ºåºé—®é¢˜ âš ï¸

#### å®Œæˆè®¢å•æ—¶çš„æ‰§è¡Œé¡ºåºï¼ˆ`handlers/order_handlers.py::set_end()`ï¼‰

```python
# ç¬¬173-175è¡Œï¼šå…ˆæ›´æ–°ç»Ÿè®¡
await update_all_stats('valid', -amount, -1, group_id)
await update_all_stats('completed', amount, 1, group_id)
await update_liquid_capital(amount)

# ç¬¬180è¡Œï¼šåè®°å½•æ”¶å…¥æ˜ç»†
await db_operations.record_income(...)
```

**é—®é¢˜**ï¼š
- å¦‚æœ `update_all_stats()` **éƒ¨åˆ†å¤±è´¥**ï¼Œå¯èƒ½å¯¼è‡´ï¼š
  - âœ… å…¨å±€ç»Ÿè®¡å·²æ›´æ–°
  - âŒ æ—¥ç»“ç»Ÿè®¡æœªæ›´æ–°
  - âŒ åˆ†ç»„ç»Ÿè®¡æœªæ›´æ–°
  - âœ… æ”¶å…¥æ˜ç»†å·²è®°å½•ï¼ˆå› ä¸ºè®°å½•åœ¨åé¢ï¼‰

### update_all_stats å‡½æ•°ç¼ºå°‘å¼‚å¸¸å¤„ç† âš ï¸

#### `utils/stats_helpers.py::update_all_stats()`

```python
async def update_all_stats(field: str, amount: float, count: int = 0, group_id: str = None, skip_daily: bool = False):
    """ç»Ÿä¸€æ›´æ–°æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼ˆå…¨å±€ã€æ—¥ç»“ã€åˆ†ç»„ï¼‰"""
    # 1. æ›´æ–°å…¨å±€æ•°æ®
    if amount != 0:
        await db_operations.update_financial_data(global_amount_field, amount)
    
    # 2. æ›´æ–°å…¨å±€æ—¥ç»“æ•°æ®
    if is_daily_field and not skip_daily:
        date = get_daily_period_date()
        if amount != 0:
            await db_operations.update_daily_data(date, daily_amount_field, amount, None)  # å…¨å±€
    
    # 3. å¦‚æœæœ‰ group_idï¼Œæ›´æ–°åˆ†ç»„æ—¥ç»“æ•°æ®
        if group_id:
            if amount != 0:
                await db_operations.update_daily_data(date, daily_amount_field, amount, group_id)  # åˆ†ç»„
    
    # 4. å¦‚æœæœ‰ group_idï¼Œæ›´æ–°åˆ†ç»„ç´¯è®¡æ•°æ®
    if group_id:
        if amount != 0:
            await db_operations.update_grouped_data(group_id, group_amount_field, amount)
```

**é—®é¢˜**ï¼š
1. **æ²¡æœ‰ try-except**ï¼šå¦‚æœæŸä¸ªæ›´æ–°å¤±è´¥ï¼Œå¼‚å¸¸ä¼šä¸­æ–­åç»­æ›´æ–°
2. **éƒ¨åˆ†æ›´æ–°æˆåŠŸ**ï¼šå‰é¢çš„æ›´æ–°å·²æˆåŠŸï¼Œåé¢çš„æ›´æ–°å¤±è´¥
3. **æ•°æ®ä¸ä¸€è‡´**ï¼šå¯¼è‡´ç»Ÿè®¡è¡¨æ•°æ®ä¸å®Œæ•´

### é—®é¢˜åœºæ™¯åˆ†æ

#### åœºæ™¯ 1ï¼šåˆ†ç»„æ—¥ç»“æ•°æ®æ›´æ–°å¤±è´¥

```
æ‰§è¡Œæµç¨‹ï¼š
1. âœ… æ›´æ–°å…¨å±€æ•°æ® (financial_data) - æˆåŠŸ
2. âœ… æ›´æ–°å…¨å±€æ—¥ç»“æ•°æ® (daily_data, group_id=NULL) - æˆåŠŸ
3. âŒ æ›´æ–°åˆ†ç»„æ—¥ç»“æ•°æ® (daily_data, group_id=S01) - å¤±è´¥ï¼ˆå¼‚å¸¸ï¼‰
4. âŒ æ›´æ–°åˆ†ç»„ç´¯è®¡æ•°æ® (grouped_data) - æœªæ‰§è¡Œ

ç»“æœï¼š
- æ”¶å…¥æ˜ç»†ï¼šâœ… å·²è®°å½•
- å…¨å±€ç»Ÿè®¡ï¼šâœ… å·²æ›´æ–°
- åˆ†ç»„ç»Ÿè®¡ï¼šâŒ æœªæ›´æ–°ï¼ˆæˆ–å°‘æ›´æ–°ï¼‰

æŸ¥è¯¢ç»“æœï¼š
- æŸ¥è¯¢å…¨å±€ç»Ÿè®¡ï¼šâœ… æ­£ç¡®
- æŸ¥è¯¢ S01 åˆ†ç»„ç»Ÿè®¡ï¼šâŒ é‡‘é¢ç¼ºå¤±
```

#### åœºæ™¯ 2ï¼šæ—¥æœŸä¸ä¸€è‡´

```
é—®é¢˜ï¼š
- update_all_stats() ä½¿ç”¨ get_daily_period_date() è·å–æ—¥æœŸ
- record_income() ä¹Ÿä½¿ç”¨ get_daily_period_date() è·å–æ—¥æœŸ
- å¦‚æœä¸¤æ¬¡è°ƒç”¨ä¹‹é—´æ—¥æœŸå‘ç”Ÿäº†å˜åŒ–ï¼ˆè·¨å¤©ï¼‰ï¼Œå¯èƒ½å¯¼è‡´æ—¥æœŸä¸åŒ¹é…

ç¤ºä¾‹ï¼š
- 23:59:58 å®Œæˆè®¢å•
- update_all_stats() è·å–æ—¥æœŸï¼š2025-12-02
- 00:00:01 record_income() è·å–æ—¥æœŸï¼š2025-12-03
- ç»“æœï¼šç»Ÿè®¡åœ¨ 2025-12-02ï¼Œæ˜ç»†åœ¨ 2025-12-03
```

#### åœºæ™¯ 3ï¼šäº‹åŠ¡å¤±è´¥ä½†è®°å½•æˆåŠŸ

```
é—®é¢˜ï¼š
- update_all_stats() ä¸­æ¯ä¸ª update_daily_data() éƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡
- å¦‚æœæŸä¸ªäº‹åŠ¡å¤±è´¥ï¼Œå…¶ä»–äº‹åŠ¡å¯èƒ½å·²æäº¤
- record_income() æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œå¯èƒ½æˆåŠŸ

ç¤ºä¾‹ï¼š
- update_daily_data(å…¨å±€) æˆåŠŸ âœ…
- update_daily_data(åˆ†ç»„) å¤±è´¥ âŒ
- record_income() æˆåŠŸ âœ…
- ç»“æœï¼šæ”¶å…¥æ˜ç»†æœ‰è®°å½•ï¼Œä½†åˆ†ç»„ç»Ÿè®¡ç¼ºå¤±
```

## ğŸ”§ ä»£ç é—®é¢˜è¯¦ç»†åˆ†æ

### é—®é¢˜ 1ï¼šupdate_all_stats ç¼ºå°‘å¼‚å¸¸å¤„ç†

**ä½ç½®**ï¼š`utils/stats_helpers.py`

**é—®é¢˜**ï¼š
- å‡½æ•°å†…éƒ¨æ²¡æœ‰ try-except
- å¦‚æœæŸä¸ªæ›´æ–°å¤±è´¥ï¼Œåç»­æ›´æ–°ä¸ä¼šæ‰§è¡Œ
- å‰é¢çš„æ›´æ–°å·²æˆåŠŸï¼Œåé¢çš„æ›´æ–°å¤±è´¥ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**ç¤ºä¾‹**ï¼š
```python
# å¦‚æœ update_daily_data(å…¨å±€) æˆåŠŸï¼Œä½† update_daily_data(åˆ†ç»„) å¤±è´¥
await db_operations.update_daily_data(date, daily_amount_field, amount, None)  # âœ… æˆåŠŸ
await db_operations.update_daily_data(date, daily_amount_field, amount, group_id)  # âŒ å¤±è´¥ï¼Œå¼‚å¸¸æŠ›å‡º
# åé¢çš„ä»£ç ä¸ä¼šæ‰§è¡Œ
```

### é—®é¢˜ 2ï¼šæ‰§è¡Œé¡ºåºå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´

**ä½ç½®**ï¼š`handlers/order_handlers.py::set_end()`

**é—®é¢˜**ï¼š
- å…ˆæ›´æ–°ç»Ÿè®¡ï¼Œåè®°å½•æ˜ç»†
- å¦‚æœç»Ÿè®¡æ›´æ–°å¤±è´¥ï¼Œä½†æ˜ç»†è®°å½•æˆåŠŸï¼Œä¼šå¯¼è‡´ä¸ä¸€è‡´
- ç›¸åçš„æƒ…å†µä¹Ÿå¯èƒ½å‘ç”Ÿ

**å»ºè®®**ï¼š
- åº”è¯¥åœ¨åŒä¸€äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œæˆ–è€…æ·»åŠ å¼‚å¸¸å¤„ç†ç¡®ä¿ä¸€è‡´æ€§

### é—®é¢˜ 3ï¼šæ—¥æœŸè·å–å¯èƒ½ä¸ä¸€è‡´

**é—®é¢˜**ï¼š
- å¤šæ¬¡è°ƒç”¨ `get_daily_period_date()` å¯èƒ½è¿”å›ä¸åŒæ—¥æœŸ
- å¦‚æœè·¨å¤©ï¼Œä¼šå¯¼è‡´æ•°æ®åˆ†æ•£åˆ°ä¸åŒæ—¥æœŸ

**å»ºè®®**ï¼š
- åœ¨å‡½æ•°å¼€å§‹æ—¶è·å–ä¸€æ¬¡æ—¥æœŸï¼Œç„¶åä¼ é€’ç»™æ‰€æœ‰å‡½æ•°

### é—®é¢˜ 4ï¼šå­—æ®µæ˜ å°„å¯èƒ½é”™è¯¯

**æ£€æŸ¥å­—æ®µæ˜ å°„**ï¼š
```python
# update_all_stats('completed', amount, 1, group_id)
# field = 'completed'
# daily_amount_field = 'completed_amount'  # âœ… æ­£ç¡®

# update_all_stats('interest', amount, 0, None)
# field = 'interest'
# daily_amount_field = 'interest'  # âœ… æ­£ç¡®ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
```

å­—æ®µæ˜ å°„çœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„ã€‚

## ğŸ” å…·ä½“æ£€æŸ¥ç‚¹

### æ£€æŸ¥ç‚¹ 1ï¼šæ˜¯å¦æœ‰å¼‚å¸¸æ—¥å¿—

æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼ŒæŸ¥æ‰¾ä»¥ä¸‹é”™è¯¯ï¼š
- `update_daily_data` ç›¸å…³é”™è¯¯
- `update_financial_data` ç›¸å…³é”™è¯¯
- `update_grouped_data` ç›¸å…³é”™è¯¯

### æ£€æŸ¥ç‚¹ 2ï¼šæ—¥æœŸä¸€è‡´æ€§

æ£€æŸ¥å®Œæˆè®¢å•çš„è®°å½•ï¼š
```sql
SELECT date, type, amount, group_id, created_at 
FROM income_records 
WHERE type = 'completed' 
ORDER BY created_at DESC;
```

å¯¹æ¯”ç»Ÿè®¡è¡¨ä¸­çš„æ—¥æœŸï¼š
```sql
SELECT date, completed_amount 
FROM daily_data 
WHERE group_id IS NULL 
ORDER BY date DESC;
```

### æ£€æŸ¥ç‚¹ 3ï¼šåˆ†ç»„ç»Ÿè®¡å®Œæ•´æ€§

æ£€æŸ¥æ¯ä¸ªå½’å±IDçš„ç»Ÿè®¡ï¼š
- æ”¶å…¥æ˜ç»†ä¸­æ¯ä¸ªå½’å±IDçš„æ€»é‡‘é¢
- ç»Ÿè®¡è¡¨ä¸­æ¯ä¸ªå½’å±IDçš„æ€»é‡‘é¢
- å¯¹æ¯”å·®å¼‚

## ğŸ’¡ ä¿®å¤å»ºè®®

### å»ºè®® 1ï¼šæ·»åŠ å¼‚å¸¸å¤„ç†å’Œå›æ»šæœºåˆ¶

```python
async def update_all_stats(field: str, amount: float, count: int = 0, group_id: str = None, skip_daily: bool = False):
    """ç»Ÿä¸€æ›´æ–°æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼ˆå…¨å±€ã€æ—¥ç»“ã€åˆ†ç»„ï¼‰"""
    # è®°å½•å·²æ‰§è¡Œçš„æ›´æ–°ï¼Œå¦‚æœå¤±è´¥å¯ä»¥å›æ»š
    executed_updates = []
    
    try:
        # 1. æ›´æ–°å…¨å±€æ•°æ®
        if amount != 0:
            await db_operations.update_financial_data(global_amount_field, amount)
            executed_updates.append(('financial_data', global_amount_field, amount))
        
        # 2. æ›´æ–°æ—¥ç»“æ•°æ®
        if is_daily_field and not skip_daily:
            date = get_daily_period_date()
            if amount != 0:
                # æ›´æ–°å…¨å±€æ—¥ç»“
                await db_operations.update_daily_data(date, daily_amount_field, amount, None)
                executed_updates.append(('daily_data', daily_amount_field, amount, None))
                
                # æ›´æ–°åˆ†ç»„æ—¥ç»“
                if group_id:
                    await db_operations.update_daily_data(date, daily_amount_field, amount, group_id)
                    executed_updates.append(('daily_data', daily_amount_field, amount, group_id))
        
        # 3. æ›´æ–°åˆ†ç»„ç´¯è®¡æ•°æ®
        if group_id:
            if amount != 0:
                await db_operations.update_grouped_data(group_id, group_amount_field, amount)
                executed_updates.append(('grouped_data', group_amount_field, amount, group_id))
    
    except Exception as e:
        # è®°å½•é”™è¯¯
        logger.error(f"æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥: {e}", exc_info=True)
        # æ³¨æ„ï¼šç”±äºæ¯ä¸ªæ›´æ–°éƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œæ— æ³•è‡ªåŠ¨å›æ»š
        # éœ€è¦æ‰‹åŠ¨ä¿®å¤æˆ–é‡æ–°è®¡ç®—
        raise  # é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®©è°ƒç”¨è€…å¤„ç†
```

### å»ºè®® 2ï¼šç»Ÿä¸€æ—¥æœŸè·å–

```python
async def set_end(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # åœ¨å‡½æ•°å¼€å§‹æ—¶è·å–ä¸€æ¬¡æ—¥æœŸ
    date = get_daily_period_date()
    
    # æ‰€æœ‰å‡½æ•°éƒ½ä½¿ç”¨åŒä¸€ä¸ªæ—¥æœŸ
    await update_all_stats('valid', -amount, -1, group_id)
    await update_all_stats('completed', amount, 1, group_id)
    await update_liquid_capital(amount)
    await db_operations.record_income(date=date, ...)  # ä½¿ç”¨ç›¸åŒçš„æ—¥æœŸ
```

### å»ºè®® 3ï¼šæ·»åŠ éªŒè¯å’Œæ—¥å¿—

```python
async def update_all_stats(...):
    # åœ¨æ›´æ–°å‰è®°å½•æ—¥å¿—
    logger.info(f"å¼€å§‹æ›´æ–°ç»Ÿè®¡: field={field}, amount={amount}, group_id={group_id}")
    
    # æ‰§è¡Œæ›´æ–°...
    
    # æ›´æ–°åéªŒè¯
    # å¯ä»¥æŸ¥è¯¢æ›´æ–°åçš„å€¼ï¼ŒéªŒè¯æ˜¯å¦æ­£ç¡®
```

## ğŸ“‹ å¿«é€Ÿè¯Šæ–­æ–¹æ³•

### æ–¹æ³• 1ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬

```bash
python æ£€æŸ¥ç»Ÿè®¡å½•å…¥ä»£ç é€»è¾‘.py
```

### æ–¹æ³• 2ï¼šé€šè¿‡ Bot å‘½ä»¤

```
/check_mismatch 2025-12-02
```

### æ–¹æ³• 3ï¼šæ£€æŸ¥æ—¥å¿—

æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼ŒæŸ¥æ‰¾ï¼š
- `æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥`
- `update_daily_data` ç›¸å…³é”™è¯¯
- æ•°æ®åº“è¿æ¥é”™è¯¯

## ğŸ”§ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœå‘ç°é‡‘é¢ç¼ºå¤±ï¼š

1. **è¿è¡Œä¿®å¤å‘½ä»¤**ï¼š
   ```
   /fix_statistics
   ```
   è¿™ä¼šé‡æ–°è®¡ç®—æ‰€æœ‰ç»Ÿè®¡æ•°æ®

2. **æ‰‹åŠ¨ä¿®å¤ç‰¹å®šè®°å½•**ï¼š
   - æŸ¥è¯¢ç¼ºå¤±çš„è®°å½•
   - æ‰‹åŠ¨è°ƒç”¨ `update_all_stats` æ›´æ–°

## ğŸ“Š æ€»ç»“

**ä¸»è¦é—®é¢˜**ï¼š
1. âœ… `update_all_stats` å‡½æ•°ç¼ºå°‘å¼‚å¸¸å¤„ç†
2. âœ… æ‰§è¡Œé¡ºåºå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´
3. âœ… æ—¥æœŸè·å–å¯èƒ½ä¸ä¸€è‡´
4. âœ… éƒ¨åˆ†æ›´æ–°å¤±è´¥å¯¼è‡´æ•°æ®ä¸å®Œæ•´

**å»ºè®®ä¿®å¤**ï¼š
1. æ·»åŠ å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—
2. ç»Ÿä¸€æ—¥æœŸè·å–
3. æ·»åŠ éªŒè¯æœºåˆ¶
4. è€ƒè™‘ä½¿ç”¨äº‹åŠ¡ç¡®ä¿ä¸€è‡´æ€§

---

**æœ€åæ›´æ–°**ï¼š2025-12-02
**ç‰ˆæœ¬**ï¼š1.0

