# 日期计算逻辑说明

## 📅 核心逻辑

### 规则
- **一个订单生成后，每7天一个周期**
- **下次付款日期 = 订单日期 + 7天**
- **下个付款日期的星期几 = 订单日期的星期几**

### 计算方式
```python
下个付款日期 = 订单日期 + timedelta(days=7)
```

## 📊 示例

### 示例 1: 周四订单
- **订单日期**: 2025-11-27 (周四)
- **计算**: 11月27日 + 7天
- **下个付款日期**: 2025-12-04 (周四)
- **结果**: 日期是周四，星期几保持一致 ✓

### 示例 2: 周三订单
- **订单日期**: 2025-11-26 (周三)
- **计算**: 11月26日 + 7天
- **下个付款日期**: 2025-12-03 (周三)
- **结果**: 日期是周三，星期几保持一致 ✓

### 示例 3: 周五订单
- **订单日期**: 2025-11-28 (周五)
- **计算**: 11月28日 + 7天
- **下个付款日期**: 2025-12-05 (周五)
- **结果**: 日期是周五，星期几保持一致 ✓

## 🔍 验证逻辑

| 订单日期 | 订单星期 | +7天 | 下个付款日期 | 付款星期 | 验证 |
|---------|---------|------|------------|---------|------|
| 2025-11-27 | 周四 | +7 | 2025-12-04 | 周四 | ✅ |
| 2025-11-26 | 周三 | +7 | 2025-12-03 | 周三 | ✅ |
| 2025-11-28 | 周五 | +7 | 2025-12-05 | 周五 | ✅ |
| 2025-11-25 | 周二 | +7 | 2025-12-02 | 周二 | ✅ |

## 💡 重要说明

1. **没有固定的星期几还款** - 完全按照订单日期计算
2. **每7天一个周期** - 订单日期 + 7天 = 下个付款日期
3. **星期几保持一致** - 如果订单是周三，下个周期必定是周三
4. **日期是计算出来的** - 根据订单日期自动计算，不依赖固定星期几

## 📝 代码实现

### 函数: `calculate_next_payment_date()`
- **位置**: `utils/broadcast_helpers.py`
- **参数**: `order_date` (订单日期，可选)
- **返回**: `(datetime对象, 日期字符串, 星期字符串)`

### 实现逻辑
```python
def calculate_next_payment_date(order_date: Optional[date] = None):
    # 1. 解析订单日期（如果是字符串）
    if isinstance(order_date, str):
        order_date = parse_date_string(order_date)
    
    # 2. 如果没有提供订单日期，使用当前日期
    if not order_date:
        order_date = datetime.now().date()
    
    # 3. 计算下个付款日期：订单日期 + 7天
    next_payment_date = order_date + timedelta(days=7)
    
    # 4. 格式化并返回
    date_str = next_payment_date.strftime("%B %d,%Y")
    weekday_str = next_payment_date.strftime("%A")
    
    return (next_payment_date, date_str, weekday_str)
```

## 🎯 使用场景

### 1. 命令播报 (`/broadcast`)
- 从订单获取订单日期
- 计算：订单日期 + 7天
- 生成播报消息

### 2. 自动播报（订单创建后）
- 使用订单创建日期
- 计算：订单日期 + 7天
- 自动发送播报消息

### 3. 手动播报（交互式）
- 可以手动输入日期
- 计算：输入日期 + 7天
- 生成播报消息

## ✅ 总结

日期计算逻辑非常简单明确：
- **订单日期 + 7天 = 下个付款日期**
- **星期几保持一致**（因为 +7天正好是一周）
- **没有固定星期几的限制**，完全按照订单日期计算

