# æ’­æŠ¥åŠŸèƒ½é€»è¾‘è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æ’­æŠ¥åŠŸèƒ½ç”¨äºå‘ç¾¤ç»„å‘é€ä»˜æ¬¾æé†’æ¶ˆæ¯ï¼ŒåŒ…å«ä»¥ä¸‹è§¦å‘æ–¹å¼ï¼š
1. **å‘½ä»¤æ’­æŠ¥** - `/broadcast` å‘½ä»¤ç›´æ¥æ’­æŠ¥
2. **æ‰‹åŠ¨æ’­æŠ¥** - äº¤äº’å¼è¾“å…¥æ’­æŠ¥ï¼ˆ3æ­¥è¾“å…¥ï¼‰
3. **è‡ªåŠ¨æ’­æŠ¥** - è®¢å•åˆ›å»ºåè‡ªåŠ¨æ’­æŠ¥
4. **å®šæ—¶æ’­æŠ¥** - å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ’­æŠ¥

---

## ğŸ”„ é€»è¾‘æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ’­æŠ¥åŠŸèƒ½å…¥å£                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€ 1. /broadcast å‘½ä»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                      â”‚
         â”œâ”€â”€â”€ 2. æ‰‹åŠ¨è¾“å…¥æ’­æŠ¥ï¼ˆäº¤äº’å¼ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                      â”‚
         â”œâ”€â”€â”€ 3. è®¢å•åˆ›å»ºåè‡ªåŠ¨æ’­æŠ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                      â”‚
         â””â”€â”€â”€ 4. å®šæ—¶ä»»åŠ¡æ’­æŠ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                              â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  æƒé™æ£€æŸ¥        â”‚
                                    â”‚  - æˆæƒç”¨æˆ·      â”‚
                                    â”‚  - ç¾¤èŠç¯å¢ƒ      â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  æ•°æ®å‡†å¤‡       â”‚
                                    â”‚  - æœ¬é‡‘é‡‘é¢     â”‚
                                    â”‚  - æœ¬é‡‘12%      â”‚
                                    â”‚  - æœªä»˜åˆ©æ¯     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  æ—¥æœŸè®¡ç®—       â”‚
                                    â”‚  - ä¸‹å‘¨äº”æ—¥æœŸ   â”‚
                                    â”‚  - æ˜ŸæœŸåç§°     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  æ¶ˆæ¯ç”Ÿæˆ       â”‚
                                    â”‚  - æ ¼å¼åŒ–é‡‘é¢   â”‚
                                    â”‚  - æ„å»ºæ¨¡æ¿     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  å‘é€æ¶ˆæ¯       â”‚
                                    â”‚  - ç¾¤ç»„å‘é€     â”‚
                                    â”‚  - é”™è¯¯å¤„ç†     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ï¸âƒ£ å‘½ä»¤æ’­æŠ¥ (`/broadcast`)

### è§¦å‘æ–¹å¼
- **å‘½ä»¤**: `/broadcast`
- **ä½ç½®**: `handlers/broadcast_handlers.py::broadcast_payment()`

### é€»è¾‘æµç¨‹

```python
1. æƒé™æ£€æŸ¥
   â”œâ”€ @authorized_required  # å¿…é¡»æ˜¯æˆæƒç”¨æˆ·
   â””â”€ @group_chat_only      # å¿…é¡»æ˜¯ç¾¤èŠ

2. æ£€æŸ¥è®¢å•
   â”œâ”€ è·å–å½“å‰ç¾¤ç»„ chat_id
   â”œâ”€ æŸ¥è¯¢è®¢å•: get_order_by_chat_id(chat_id)
   â””â”€ å¦‚æœæ²¡æœ‰è®¢å• â†’ è¿”å›é”™è¯¯ "âŒ å½“å‰ç¾¤ç»„æ²¡æœ‰æ´»è·ƒè®¢å•"

3. è·å–æ•°æ®
   â”œâ”€ principal = order.get('amount', 0)        # ä»è®¢å•è·å–æœ¬é‡‘
   â”œâ”€ principal_12 = principal * 0.12            # è®¡ç®—æœ¬é‡‘12%
   â””â”€ outstanding_interest = 0                   # æœªä»˜åˆ©æ¯é»˜è®¤ä¸º0

4. ç”Ÿæˆæ¶ˆæ¯
   â”œâ”€ è®¡ç®—ä¸‹å‘¨äº”æ—¥æœŸ: calculate_next_payment_date()
   â””â”€ æ ¼å¼åŒ–æ¶ˆæ¯: format_broadcast_message()

5. å‘é€æ¶ˆæ¯
   â”œâ”€ å‘é€åˆ°ç¾¤ç»„: bot.send_message(chat_id, message)
   â””â”€ é™é»˜å®Œæˆï¼ˆä¸å‘é€å›å¤æ¶ˆæ¯ï¼‰
```

### ç‰¹ç‚¹
- âœ… **å¿«é€Ÿæ’­æŠ¥** - ä¸€é”®å‘é€ï¼Œæ— éœ€è¾“å…¥
- âœ… **è‡ªåŠ¨è·å–** - ä»è®¢å•è‡ªåŠ¨è·å–æœ¬é‡‘
- âœ… **é™é»˜å®Œæˆ** - ä¸å‘é€ç¡®è®¤æ¶ˆæ¯

---

## 2ï¸âƒ£ æ‰‹åŠ¨è¾“å…¥æ’­æŠ¥ï¼ˆäº¤äº’å¼ï¼‰

### è§¦å‘æ–¹å¼
- **çŠ¶æ€**: `context.user_data['state'] == 'BROADCASTING'`
- **ä½ç½®**: `handlers/broadcast_handlers.py::handle_broadcast_payment_input()`

### é€»è¾‘æµç¨‹

#### æ­¥éª¤ 1: è¾“å…¥æœ¬é‡‘
```python
1. æ£€æŸ¥å–æ¶ˆ
   â””â”€ å¦‚æœè¾“å…¥ 'cancel' â†’ å–æ¶ˆæ“ä½œï¼Œæ¸…é™¤çŠ¶æ€

2. éªŒè¯è¾“å…¥
   â”œâ”€ è½¬æ¢ä¸º float
   â”œâ”€ æ£€æŸ¥ > 0
   â””â”€ å¦‚æœæ— æ•ˆ â†’ è¿”å›é”™è¯¯

3. ä¿å­˜æ•°æ®
   â”œâ”€ data['principal'] = principal
   â”œâ”€ context.user_data['broadcast_step'] = 2
   â””â”€ æç¤ºè¾“å…¥æœ¬é‡‘12%
```

#### æ­¥éª¤ 2: è¾“å…¥æœ¬é‡‘12%
```python
1. æ£€æŸ¥è¾“å…¥
   â”œâ”€ å¦‚æœè¾“å…¥ 'auto' â†’ è‡ªåŠ¨è®¡ç®—: principal * 0.12
   â””â”€ å¦åˆ™ â†’ éªŒè¯è¾“å…¥çš„æ•°å€¼

2. éªŒè¯è¾“å…¥
   â”œâ”€ è½¬æ¢ä¸º float
   â”œâ”€ æ£€æŸ¥ > 0
   â””â”€ å¦‚æœæ— æ•ˆ â†’ è¿”å›é”™è¯¯

3. ä¿å­˜æ•°æ®
   â”œâ”€ data['principal_12'] = principal_12
   â”œâ”€ context.user_data['broadcast_step'] = 3
   â””â”€ æç¤ºè¾“å…¥æœªä»˜åˆ©æ¯
```

#### æ­¥éª¤ 3: è¾“å…¥æœªä»˜åˆ©æ¯
```python
1. éªŒè¯è¾“å…¥
   â”œâ”€ è½¬æ¢ä¸º float
   â”œâ”€ æ£€æŸ¥ >= 0ï¼ˆå¯ä»¥ä¸º0ï¼‰
   â””â”€ å¦‚æœæ— æ•ˆ â†’ è¿”å›é”™è¯¯

2. ä¿å­˜æ•°æ®
   â””â”€ data['outstanding_interest'] = outstanding_interest

3. å‘é€æ’­æŠ¥
   â”œâ”€ è°ƒç”¨ send_broadcast_message()
   â”œâ”€ æ¸…é™¤çŠ¶æ€
   â””â”€ æ˜¾ç¤ºæŒ‰é’®ï¼ˆæ˜¯å¦å‘é€æœ¬é‡‘12%ç‰ˆæœ¬ï¼‰
```

### å‘é€æ’­æŠ¥æ¶ˆæ¯ (`send_broadcast_message`)

```python
1. è·å–æ•°æ®
   â”œâ”€ principal = data.get('principal', 0)
   â”œâ”€ principal_12 = data.get('principal_12', 0)
   â””â”€ outstanding_interest = data.get('outstanding_interest', 0)

2. ç”Ÿæˆæ¶ˆæ¯
   â”œâ”€ è®¡ç®—æ—¥æœŸ: calculate_next_payment_date()
   â””â”€ æ ¼å¼åŒ–: format_broadcast_message()

3. å‘é€æ¶ˆæ¯
   â”œâ”€ å‘é€åˆ°ç¾¤ç»„: bot.send_message(chat_id, message)
   â””â”€ ä¿å­˜æ•°æ®åˆ° contextï¼ˆç”¨äºåç»­å‘é€æœ¬é‡‘12%ç‰ˆæœ¬ï¼‰

4. æ˜¾ç¤ºæŒ‰é’®
   â”œâ”€ "å‘é€æœ¬é‡‘12%ç‰ˆæœ¬" æŒ‰é’®
   â””â”€ "å®Œæˆ" æŒ‰é’®
```

### ç‰¹ç‚¹
- âœ… **çµæ´»è¾“å…¥** - å¯ä»¥æ‰‹åŠ¨è¾“å…¥æ‰€æœ‰å‚æ•°
- âœ… **è‡ªåŠ¨è®¡ç®—** - æ”¯æŒ 'auto' è‡ªåŠ¨è®¡ç®—æœ¬é‡‘12%
- âœ… **å¯é€‰å‘é€** - å¯ä»¥é€‰æ‹©æ˜¯å¦å‘é€æœ¬é‡‘12%ç‰ˆæœ¬

---

## 3ï¸âƒ£ è®¢å•åˆ›å»ºåè‡ªåŠ¨æ’­æŠ¥

### è§¦å‘æ–¹å¼
- **ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`
- **è°ƒç”¨**: è®¢å•åˆ›å»ºæˆåŠŸåè‡ªåŠ¨è°ƒç”¨

### é€»è¾‘æµç¨‹

```python
1. è®¢å•åˆ›å»ºæˆåŠŸ
   â””â”€ è°ƒç”¨ send_auto_broadcast(update, context, chat_id, amount)

2. è®¡ç®—æ•°æ®
   â”œâ”€ principal = amount                    # è®¢å•é‡‘é¢ä½œä¸ºæœ¬é‡‘
   â”œâ”€ principal_12 = principal * 0.12      # è®¡ç®—æœ¬é‡‘12%
   â””â”€ outstanding_interest = 0              # æ–°è®¢å•æœªä»˜åˆ©æ¯ä¸º0

3. ç”Ÿæˆæ¶ˆæ¯
   â”œâ”€ ä½¿ç”¨ format_broadcast_message()
   â””â”€ è‡ªåŠ¨è®¡ç®—ä¸‹å‘¨äº”æ—¥æœŸ

4. å‘é€æ¶ˆæ¯
   â”œâ”€ å‘é€åˆ°ç¾¤ç»„: bot.send_message(chat_id, message)
   â””â”€ é™é»˜å¤±è´¥ï¼ˆä¸æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·ï¼‰
```

### ç‰¹ç‚¹
- âœ… **è‡ªåŠ¨è§¦å‘** - è®¢å•åˆ›å»ºåè‡ªåŠ¨æ’­æŠ¥
- âœ… **æ— éœ€è¾“å…¥** - è‡ªåŠ¨ä½¿ç”¨è®¢å•é‡‘é¢
- âœ… **é™é»˜å¤±è´¥** - å¤±è´¥ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œä¸å½±å“è®¢å•åˆ›å»º

---

## 4ï¸âƒ£ å®šæ—¶æ’­æŠ¥

### è§¦å‘æ–¹å¼
- **ä½ç½®**: `utils/schedule_executor.py`
- **åˆå§‹åŒ–**: `main.py` å¯åŠ¨æ—¶è°ƒç”¨ `setup_scheduled_broadcasts()`

### é€»è¾‘æµç¨‹

#### è®¾ç½®å®šæ—¶æ’­æŠ¥ (`setup_scheduled_broadcasts`)

```python
1. æŸ¥è¯¢å®šæ—¶æ’­æŠ¥é…ç½®
   â””â”€ ä»æ•°æ®åº“è·å–: get_all_scheduled_broadcasts()

2. ä¸ºæ¯ä¸ªæ’­æŠ¥åˆ›å»ºå®šæ—¶ä»»åŠ¡
   â”œâ”€ è§£ææ—¶é—´æ§½ (slot): "HH:MM" æ ¼å¼
   â”œâ”€ åˆ›å»º AsyncIOScheduler ä»»åŠ¡
   â””â”€ æ¯å¤©åœ¨æŒ‡å®šæ—¶é—´æ‰§è¡Œ

3. ä»»åŠ¡æ‰§è¡Œ
   â””â”€ è°ƒç”¨ send_scheduled_broadcast(bot, broadcast)
```

#### å‘é€å®šæ—¶æ’­æŠ¥ (`send_scheduled_broadcast`)

```python
1. è·å–æ’­æŠ¥é…ç½®
   â”œâ”€ chat_id = broadcast['chat_id']      # ç¾¤ç»„ID
   â””â”€ message = broadcast['message']       # é¢„å…ˆç”Ÿæˆçš„æ¶ˆæ¯ï¼ˆå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼‰

2. éªŒè¯é…ç½®
   â””â”€ å¦‚æœ chat_id ä¸ºç©º â†’ è·³è¿‡å‘é€ï¼Œè®°å½•è­¦å‘Š

3. å‘é€æ¶ˆæ¯
   â”œâ”€ å‘é€åˆ°ç¾¤ç»„: bot.send_message(chat_id, message)
   â””â”€ è®°å½•æ—¥å¿—

æ³¨æ„: å®šæ—¶æ’­æŠ¥çš„æ¶ˆæ¯æ˜¯é¢„å…ˆå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ï¼Œä¸æ˜¯åŠ¨æ€ç”Ÿæˆçš„ã€‚
     éœ€è¦åœ¨è®¾ç½®å®šæ—¶æ’­æŠ¥æ—¶ï¼Œä½¿ç”¨ format_broadcast_message() ç”Ÿæˆæ¶ˆæ¯å¹¶ä¿å­˜ã€‚
```

### ç‰¹ç‚¹
- âœ… **å®šæ—¶æ‰§è¡Œ** - æ¯å¤©åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨æ’­æŠ¥
- âœ… **é…ç½®åŒ–** - ä»æ•°æ®åº“è¯»å–é…ç½®
- âœ… **å¤šç¾¤ç»„** - æ”¯æŒå¤šä¸ªç¾¤ç»„ä¸åŒæ—¶é—´æ’­æŠ¥
- âœ… **æ‰‹åŠ¨è¾“å…¥** - æ¶ˆæ¯å†…å®¹ç”±ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ï¼ˆä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆï¼‰

### å®šæ—¶æ’­æŠ¥è®¾ç½®æµç¨‹

#### è®¾ç½®å®šæ—¶æ’­æŠ¥ (`/schedule` å‘½ä»¤)

```python
1. æ˜¾ç¤ºèœå•
   â””â”€ æ˜¾ç¤º3ä¸ªæ’­æŠ¥æ§½ä½çš„çŠ¶æ€

2. é€‰æ‹©æ§½ä½
   â””â”€ ç‚¹å‡» "è®¾ç½®æ’­æŠ¥ X" æˆ– "ç¼–è¾‘æ’­æŠ¥ X"

3. è®¾ç½®æ—¶é—´ (SCHEDULE_TIME_X)
   â”œâ”€ è¾“å…¥æ ¼å¼: "HH" æˆ– "HH:MM"
   â”œâ”€ éªŒè¯: 0-23å°æ—¶, 0-59åˆ†é’Ÿ
   â””â”€ ä¿å­˜åˆ° context.user_data['schedule_data'][slot]['time']

4. è®¾ç½®ç¾¤ç»„ (SCHEDULE_CHAT_X)
   â”œâ”€ è¾“å…¥ç¾¤ç»„åç§°æˆ–ç¾¤ç»„ID
   â”œâ”€ å¦‚æœæ˜¯æ•°å­— â†’ ä½œä¸º chat_id
   â””â”€ å¦åˆ™ â†’ ä½œä¸º chat_title
   â””â”€ ä¿å­˜åˆ° context.user_data['schedule_data'][slot]

5. è®¾ç½®æ¶ˆæ¯ (SCHEDULE_MESSAGE_X)
   â”œâ”€ è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼ˆç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ï¼‰
   â”œâ”€ ä¿å­˜åˆ° context.user_data['schedule_data'][slot]['message']
   â””â”€ æ£€æŸ¥æ‰€æœ‰å­—æ®µæ˜¯å¦å®Œæ•´

6. ä¿å­˜åˆ°æ•°æ®åº“
   â”œâ”€ è°ƒç”¨ create_or_update_scheduled_broadcast()
   â”œâ”€ é‡æ–°åŠ è½½å®šæ—¶ä»»åŠ¡: reload_scheduled_broadcasts()
   â””â”€ æ¸…é™¤çŠ¶æ€
```

**æ³¨æ„**: å®šæ—¶æ’­æŠ¥çš„æ¶ˆæ¯å†…å®¹æ˜¯ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥çš„ï¼Œä¸æ˜¯ä½¿ç”¨ `format_broadcast_message()` è‡ªåŠ¨ç”Ÿæˆçš„ã€‚

---

## 5ï¸âƒ£ æ—¥æœŸè®¡ç®—é€»è¾‘

### å‡½æ•°: `calculate_next_payment_date()`
- **ä½ç½®**: `utils/broadcast_helpers.py`

### è®¡ç®—é€»è¾‘

```python
1. è·å–è®¢å•æ—¥æœŸ
   â”œâ”€ å¦‚æœæä¾›äº† order_date å‚æ•° â†’ ä½¿ç”¨è®¢å•æ—¥æœŸ
   â””â”€ å¦‚æœæ²¡æœ‰æä¾› â†’ ä½¿ç”¨å½“å‰æ—¥æœŸ

2. è§£æè®¢å•æ—¥æœŸï¼ˆå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼‰
   â”œâ”€ æ ¼å¼: "YYYY-MM-DD HH:MM:SS" æˆ– "YYYY-MM-DD"
   â””â”€ æå–æ—¥æœŸéƒ¨åˆ†å¹¶è§£æ

3. è®¡ç®—ä¸‹ä¸ªä»˜æ¬¾æ—¥æœŸ
   â””â”€ next_payment_date = è®¢å•æ—¥æœŸ + 7å¤©
   â””â”€ ä½¿ç”¨ timedelta(days=7) è®¡ç®—

4. æ ¼å¼åŒ–æ—¥æœŸ
   â”œâ”€ date_str = next_payment_date.strftime("%B %d,%Y")  # "December 4,2025"
   â””â”€ weekday_str = next_payment_date.strftime("%A")      # "Thursday"

5. è¿”å›ç»“æœ
   â””â”€ (next_payment_datetime, date_str, weekday_str)
```

### é‡è¦è¯´æ˜
- âœ… **æ²¡æœ‰å›ºå®šçš„æ˜ŸæœŸå‡ è¿˜æ¬¾** - å®Œå…¨æŒ‰ç…§è®¢å•æ—¥æœŸè®¡ç®—
- âœ… **æ¯7å¤©ä¸€ä¸ªå‘¨æœŸ** - è®¢å•æ—¥æœŸ + 7å¤© = ä¸‹ä¸ªä»˜æ¬¾æ—¥æœŸ
- âœ… **æ˜ŸæœŸå‡ ä¿æŒä¸€è‡´** - å¦‚æœè®¢å•æ˜¯å‘¨ä¸‰ï¼Œä¸‹ä¸ªå‘¨æœŸå¿…å®šæ˜¯å‘¨ä¸‰ï¼ˆå› ä¸º+7å¤©æ­£å¥½æ˜¯ä¸€å‘¨ï¼‰

### ç¤ºä¾‹
- **è®¢å•æ—¥æœŸ**: 2025-11-27 (å‘¨å››)
- **ä¸‹ä¸ªä»˜æ¬¾æ—¥æœŸ**: 2025-12-04 (å‘¨å››) = 11æœˆ27æ—¥ + 7å¤©
- **æ—¥æœŸå­—ç¬¦ä¸²**: "December 4,2025"
- **æ˜ŸæœŸå­—ç¬¦ä¸²**: "Thursday"
- **éªŒè¯**: è®¢å•æ˜¯å‘¨å››ï¼Œä¸‹ä¸ªå‘¨æœŸä¹Ÿæ˜¯å‘¨å›› âœ“

- **è®¢å•æ—¥æœŸ**: 2025-11-26 (å‘¨ä¸‰)
- **ä¸‹ä¸ªä»˜æ¬¾æ—¥æœŸ**: 2025-12-03 (å‘¨ä¸‰) = 11æœˆ26æ—¥ + 7å¤©
- **æ—¥æœŸå­—ç¬¦ä¸²**: "December 3,2025"
- **æ˜ŸæœŸå­—ç¬¦ä¸²**: "Wednesday"
- **éªŒè¯**: è®¢å•æ˜¯å‘¨ä¸‰ï¼Œä¸‹ä¸ªå‘¨æœŸä¹Ÿæ˜¯å‘¨ä¸‰ âœ“

---

## 6ï¸âƒ£ æ¶ˆæ¯æ¨¡æ¿ç”Ÿæˆ

### å‡½æ•°: `format_broadcast_message()`
- **ä½ç½®**: `utils/broadcast_helpers.py`

### å‚æ•°
```python
- principal: float              # æœ¬é‡‘é‡‘é¢
- principal_12: float          # æœ¬é‡‘12%é‡‘é¢
- outstanding_interest: float   # æœªä»˜åˆ©æ¯ï¼ˆé»˜è®¤0ï¼‰
- date_str: str                # æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨è®¡ç®—ï¼‰
- weekday_str: str             # æ˜ŸæœŸå­—ç¬¦ä¸²ï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨è®¡ç®—ï¼‰
```

### ç”Ÿæˆé€»è¾‘

```python
1. æ—¥æœŸå¤„ç†
   â”œâ”€ å¦‚æœ date_str æˆ– weekday_str ä¸º None
   â”‚  â””â”€ è‡ªåŠ¨è®¡ç®—: calculate_next_payment_date()
   â””â”€ å¦åˆ™ä½¿ç”¨æä¾›çš„æ—¥æœŸ

2. é‡‘é¢æ ¼å¼åŒ–
   â”œâ”€ principal_formatted = f"{principal:,.0f}"      # "7,000"
   â””â”€ principal_12_formatted = f"{principal_12:,.0f}"  # "840"

3. æ„å»ºæ¶ˆæ¯
   â””â”€ message = (
        f"Your next payment is due on {date_str} ({weekday_str}) "
        f"for {principal_formatted} or {principal_12_formatted} to defer the principal payment for one week.\n\n"
        f"Your outstanding interest is {outstanding_interest}"
      )
```

### æ¶ˆæ¯æ¨¡æ¿ç¤ºä¾‹

```
Your next payment is due on November 28,2025 (Friday) 
for 7,000 or 840 to defer the principal payment for one week.

Your outstanding interest is 0
```

---

## 7ï¸âƒ£ å›è°ƒå¤„ç†ï¼ˆæœ¬é‡‘12%ç‰ˆæœ¬ï¼‰

### è§¦å‘æ–¹å¼
- **æŒ‰é’®**: "å‘é€æœ¬é‡‘12%ç‰ˆæœ¬" æŒ‰é’®
- **ä½ç½®**: `callbacks/main_callback.py::button_callback()`

### é€»è¾‘æµç¨‹

```python
1. æ£€æŸ¥å›è°ƒæ•°æ®
   â””â”€ if data == "broadcast_send_12":

2. è·å–ä¿å­˜çš„æ•°æ®
   â”œâ”€ principal_12 = context.user_data.get('broadcast_principal_12', 0)
   â”œâ”€ outstanding_interest = context.user_data.get('broadcast_outstanding_interest', 0)
   â”œâ”€ date_str = context.user_data.get('broadcast_date_str', '')
   â””â”€ weekday_str = context.user_data.get('broadcast_weekday_str', 'Friday')

3. éªŒè¯æ•°æ®
   â””â”€ if principal_12 == 0 â†’ è¿”å›é”™è¯¯

4. ç”Ÿæˆæ¶ˆæ¯
   â”œâ”€ ä½¿ç”¨ format_broadcast_message()
   â”œâ”€ principal = principal_12  # æœ¬é‡‘12%ç‰ˆæœ¬ï¼Œåªæ˜¾ç¤ºè¿™ä¸ªé‡‘é¢
   â””â”€ principal_12 = principal_12

5. å‘é€æ¶ˆæ¯
   â”œâ”€ å‘é€åˆ°ç¾¤ç»„: bot.send_message(chat_id, message)
   â”œâ”€ æ¸…é™¤ä¸´æ—¶æ•°æ®
   â””â”€ æ›´æ–°æŒ‰é’®çŠ¶æ€
```

### ç‰¹ç‚¹
- âœ… **å¯é€‰å‘é€** - ç”¨æˆ·å¯ä»¥é€‰æ‹©æ˜¯å¦å‘é€æœ¬é‡‘12%ç‰ˆæœ¬
- âœ… **æ•°æ®å¤ç”¨** - å¤ç”¨ä¹‹å‰ä¿å­˜çš„æ—¥æœŸå’Œåˆ©æ¯æ•°æ®

---

## ğŸ“Š æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®æ¥æº                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. è®¢å•æ•°æ® (orders è¡¨)                                â”‚
â”‚     â””â”€ amount â†’ principal, principal_12                â”‚
â”‚                                                          â”‚
â”‚  2. ç”¨æˆ·è¾“å…¥ (äº¤äº’å¼)                                    â”‚
â”‚     â”œâ”€ principal (æ‰‹åŠ¨è¾“å…¥)                             â”‚
â”‚     â”œâ”€ principal_12 (æ‰‹åŠ¨è¾“å…¥æˆ– auto)                  â”‚
â”‚     â””â”€ outstanding_interest (æ‰‹åŠ¨è¾“å…¥)                  â”‚
â”‚                                                          â”‚
â”‚  3. å®šæ—¶æ’­æŠ¥é…ç½® (scheduled_broadcasts è¡¨)              â”‚
â”‚     â”œâ”€ principal                                        â”‚
â”‚     â”œâ”€ principal_12                                     â”‚
â”‚     â””â”€ outstanding_interest                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å¤„ç†                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ è®¡ç®—æœ¬é‡‘12%: principal * 0.12                        â”‚
â”‚  â€¢ è®¡ç®—ä¸‹å‘¨äº”æ—¥æœŸ: calculate_next_payment_date()        â”‚
â”‚  â€¢ æ ¼å¼åŒ–é‡‘é¢: æ·»åŠ åƒä½åˆ†éš”ç¬¦                           â”‚
â”‚  â€¢ ç”Ÿæˆæ¶ˆæ¯: format_broadcast_message()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¶ˆæ¯å‘é€                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ å‘é€åˆ°ç¾¤ç»„: bot.send_message(chat_id, message)       â”‚
â”‚  â€¢ é”™è¯¯å¤„ç†: è®°å½•æ—¥å¿—ï¼Œæ˜¾ç¤ºé”™è¯¯ï¼ˆå¦‚éœ€è¦ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æƒé™æ§åˆ¶

### æƒé™æ£€æŸ¥
```python
@authorized_required  # å¿…é¡»æ˜¯æˆæƒç”¨æˆ·ï¼ˆç®¡ç†å‘˜æˆ–å‘˜å·¥ï¼‰
@group_chat_only     # å¿…é¡»æ˜¯ç¾¤èŠç¯å¢ƒ
```

### æƒé™å±‚çº§
1. **ç®¡ç†å‘˜** (`ADMIN_IDS`) - å®Œå…¨æƒé™
2. **æˆæƒå‘˜å·¥** (`employees` è¡¨) - å¯ä»¥ä½¿ç”¨æ’­æŠ¥åŠŸèƒ½
3. **æœªæˆæƒç”¨æˆ·** - æ— æ³•ä½¿ç”¨

---

## âš ï¸ é”™è¯¯å¤„ç†

### é”™è¯¯ç±»å‹
1. **æ— è®¢å•é”™è¯¯**
   - è§¦å‘: `/broadcast` å‘½ä»¤ä½†ç¾¤ç»„æ²¡æœ‰è®¢å•
   - å¤„ç†: è¿”å› "âŒ å½“å‰ç¾¤ç»„æ²¡æœ‰æ´»è·ƒè®¢å•"

2. **è¾“å…¥éªŒè¯é”™è¯¯**
   - è§¦å‘: è¾“å…¥æ— æ•ˆæ•°å­—æˆ–è´Ÿæ•°
   - å¤„ç†: è¿”å›ç›¸åº”é”™è¯¯æç¤º

3. **å‘é€å¤±è´¥é”™è¯¯**
   - è§¦å‘: Telegram API è°ƒç”¨å¤±è´¥
   - å¤„ç†: è®°å½•æ—¥å¿—ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆå‘½ä»¤æ’­æŠ¥ï¼‰æˆ–é™é»˜å¤±è´¥ï¼ˆè‡ªåŠ¨æ’­æŠ¥ï¼‰

---

## ğŸ“ å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | å‡½æ•° |
|------|------|------|
| å‘½ä»¤æ’­æŠ¥ | `handlers/broadcast_handlers.py` | `broadcast_payment()` |
| æ‰‹åŠ¨è¾“å…¥æ’­æŠ¥ | `handlers/broadcast_handlers.py` | `handle_broadcast_payment_input()` |
| å‘é€æ’­æŠ¥æ¶ˆæ¯ | `handlers/broadcast_handlers.py` | `send_broadcast_message()` |
| è‡ªåŠ¨æ’­æŠ¥ | `utils/order_helpers.py` | `send_auto_broadcast()` |
| å®šæ—¶æ’­æŠ¥è®¾ç½® | `utils/schedule_executor.py` | `setup_scheduled_broadcasts()` |
| å®šæ—¶æ’­æŠ¥å‘é€ | `utils/schedule_executor.py` | `send_scheduled_broadcast()` |
| æ—¥æœŸè®¡ç®— | `utils/broadcast_helpers.py` | `calculate_next_payment_date()` |
| æ¶ˆæ¯ç”Ÿæˆ | `utils/broadcast_helpers.py` | `format_broadcast_message()` |
| å›è°ƒå¤„ç† | `callbacks/main_callback.py` | `button_callback()` |

---

## ğŸ¯ æ€»ç»“

æ’­æŠ¥åŠŸèƒ½æä¾›äº†**4ç§è§¦å‘æ–¹å¼**ï¼Œç»Ÿä¸€ä½¿ç”¨**ç›¸åŒçš„æ¶ˆæ¯æ¨¡æ¿**å’Œ**æ—¥æœŸè®¡ç®—é€»è¾‘**ï¼š

1. âœ… **å‘½ä»¤æ’­æŠ¥** - å¿«é€Ÿä¸€é”®æ’­æŠ¥
2. âœ… **æ‰‹åŠ¨æ’­æŠ¥** - çµæ´»è¾“å…¥å‚æ•°
3. âœ… **è‡ªåŠ¨æ’­æŠ¥** - è®¢å•åˆ›å»ºåè‡ªåŠ¨è§¦å‘
4. âœ… **å®šæ—¶æ’­æŠ¥** - å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œ

æ‰€æœ‰æ’­æŠ¥éƒ½ä½¿ç”¨ç»Ÿä¸€çš„å·¥å…·å‡½æ•°ï¼Œç¡®ä¿æ¶ˆæ¯æ ¼å¼ä¸€è‡´ï¼Œæ˜“äºç»´æŠ¤ã€‚

