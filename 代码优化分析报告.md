# ä»£ç ä¼˜åŒ–åˆ†ææŠ¥å‘Š

## ğŸ“‹ åˆ†æèŒƒå›´

å¯¹æ•´ä¸ªä»£ç åº“è¿›è¡Œä¼˜åŒ–åˆ†æï¼Œé‡ç‚¹å…³æ³¨ï¼š
1. ä»£ç ç®€åŒ–
2. é‡å¤é€»è¾‘æ¶ˆé™¤
3. æ€§èƒ½ä¼˜åŒ–
4. å¯ç»´æŠ¤æ€§æå‡

---

## ğŸ” å‘ç°çš„ä¼˜åŒ–ç‚¹

### 1. main.py - æ•°æ®åº“å¤‡ä»½å¯¼å…¥é€»è¾‘é‡å¤

**é—®é¢˜**: æ•°æ®åº“å¤‡ä»½å¯¼å…¥é€»è¾‘æœ‰é‡å¤ä»£ç 

**ä½ç½®**: `main.py` ç¬¬ 90-147 è¡Œ

**å½“å‰ä»£ç **:
```python
if not os.path.exists(db_path):
    # å¯¼å…¥å¤‡ä»½é€»è¾‘ï¼ˆçº¦20è¡Œï¼‰
else:
    # æ£€æŸ¥æ˜¯å¦ä¸ºç©º
    if table_count == 0:
        # å¯¼å…¥å¤‡ä»½é€»è¾‘ï¼ˆå‡ ä¹ç›¸åŒçš„20è¡Œï¼‰
```

**ä¼˜åŒ–æ–¹æ¡ˆ**: æå–ä¸ºç‹¬ç«‹å‡½æ•°

**ä¼˜åŒ–å**:
```python
def import_database_backup(backup_file: str, db_path: str) -> bool:
    """å¯¼å…¥æ•°æ®åº“å¤‡ä»½"""
    try:
        import sqlite3
        db_dir = os.path.dirname(db_path)
        if db_dir and not os.path.exists(db_dir):
            os.makedirs(db_dir, exist_ok=True)
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        with open(backup_file, 'r', encoding='utf-8') as f:
            sql_script = f.read()
        
        cursor.executescript(sql_script)
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        logger.error(f"å¯¼å…¥æ•°æ®åº“å¤‡ä»½å¤±è´¥: {e}", exc_info=True)
        return False
```

**æ”¶ç›Š**: 
- å‡å°‘çº¦40è¡Œé‡å¤ä»£ç 
- æé«˜å¯ç»´æŠ¤æ€§
- ç»Ÿä¸€é”™è¯¯å¤„ç†

---

### 2. main.py - UnicodeEncodeError å¤„ç†é‡å¤

**é—®é¢˜**: å¤šå¤„é‡å¤çš„ UnicodeEncodeError å¤„ç†

**ä½ç½®**: `main.py` å¤šå¤„

**å½“å‰ä»£ç **:
```python
try:
    print("ä¸­æ–‡æ¶ˆæ¯")
except UnicodeEncodeError:
    print("English message")
```

**ä¼˜åŒ–æ–¹æ¡ˆ**: åˆ›å»ºç»Ÿä¸€çš„æ‰“å°å‡½æ•°

**ä¼˜åŒ–å**:
```python
def safe_print(*args, **kwargs):
    """å®‰å…¨çš„æ‰“å°å‡½æ•°ï¼Œè‡ªåŠ¨å¤„ç†ç¼–ç é—®é¢˜"""
    try:
        print(*args, **kwargs)
    except UnicodeEncodeError:
        # å¦‚æœåŒ…å«ä¸­æ–‡ï¼Œå°è¯•ä½¿ç”¨è‹±æ–‡æ›¿ä»£
        if args:
            # å¯ä»¥å®šä¹‰è‹±æ–‡æ˜ å°„æˆ–ä½¿ç”¨ASCIIå­—ç¬¦
            print(*[str(arg).encode('ascii', 'ignore').decode('ascii') for arg in args], **kwargs)
```

**æ”¶ç›Š**:
- å‡å°‘é‡å¤ä»£ç 
- ç»Ÿä¸€ç¼–ç å¤„ç†
- ç®€åŒ–ä»£ç 

---

### 3. utils/order_helpers.py - è®¢å•åˆ›å»ºæ¶ˆæ¯æ„å»ºé‡å¤

**é—®é¢˜**: æ­£å¸¸è®¢å•å’Œå†å²è®¢å•çš„æ¶ˆæ¯æ„å»ºé€»è¾‘ç›¸ä¼¼

**ä½ç½®**: `utils/order_helpers.py` ç¬¬ 247-280 è¡Œ

**ä¼˜åŒ–æ–¹æ¡ˆ**: æå–æ¶ˆæ¯æ„å»ºå‡½æ•°

**ä¼˜åŒ–å**:
```python
def build_order_creation_message(order_id, group_id, created_at, weekday_group, 
                                 customer, amount, initial_state, is_historical=False):
    """æ„å»ºè®¢å•åˆ›å»ºæˆåŠŸæ¶ˆæ¯"""
    base_msg = (
        f"âœ… {'Historical Order Imported' if is_historical else 'Order Created Successfully'}\n\n"
        f"ğŸ“‹ Order ID: {order_id}\n"
        f"ğŸ·ï¸ Group ID: {group_id}\n"
        f"ğŸ“… Date: {created_at}\n"
    )
    
    if not is_historical:
        base_msg += f"ğŸ‘¥ Week Group: {weekday_group}\n"
    
    base_msg += (
        f"ğŸ‘¤ Customer: {'New' if customer == 'A' else 'Returning'}"
        f"{' (Historical)' if is_historical else ''}\n"
        f"ğŸ’° Amount: {amount:.2f}\n"
        f"ğŸ“ˆ Status: {initial_state}"
    )
    
    if is_historical:
        base_msg += "\nâš ï¸ Funds Update: Skipped (Historical Data Only)\nğŸ“¢ Broadcast: Skipped (Historical Data Only)"
    
    return base_msg
```

**æ”¶ç›Š**:
- å‡å°‘é‡å¤ä»£ç 
- ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼
- æ˜“äºç»´æŠ¤

---

### 4. handlers/message_handlers.py - é”™è¯¯å¤„ç†é‡å¤

**é—®é¢˜**: å¤šä¸ªå‡½æ•°ä¸­é‡å¤çš„é”™è¯¯å¤„ç†æ¨¡å¼

**ä¼˜åŒ–æ–¹æ¡ˆ**: ä½¿ç”¨è£…é¥°å™¨ç»Ÿä¸€å¤„ç†

**å·²å®ç°**: `@error_handler` è£…é¥°å™¨å·²å­˜åœ¨

**å»ºè®®**: ç¡®ä¿æ‰€æœ‰å‡½æ•°éƒ½ä½¿ç”¨è£…é¥°å™¨

---

### 5. ç»Ÿè®¡æ›´æ–°é€»è¾‘ - å¯ä»¥æå–å…¬å…±å‡½æ•°

**é—®é¢˜**: å¤šå¤„é‡å¤çš„ç»Ÿè®¡æ›´æ–°æ¨¡å¼

**ä½ç½®**: `utils/order_helpers.py` å¤šå¤„

**ä¼˜åŒ–æ–¹æ¡ˆ**: åˆ›å»ºç»Ÿä¸€çš„ç»Ÿè®¡æ›´æ–°å‡½æ•°

**ä¼˜åŒ–å**:
```python
async def update_order_statistics(group_id: str, amount: float, 
                                 initial_state: str, customer: str, 
                                 is_historical: bool = False):
    """ç»Ÿä¸€æ›´æ–°è®¢å•ç»Ÿè®¡"""
    is_breach = (initial_state == 'breach')
    
    # æ›´æ–°è®¢å•ç»Ÿè®¡
    if is_breach:
        await update_all_stats('breach', amount, 1, group_id)
    else:
        await update_all_stats('valid', amount, 1, group_id)
    
    # éå†å²è®¢å•æ‰æ‰£æ¬¾å’Œæ›´æ–°å®¢æˆ·ç»Ÿè®¡
    if not is_historical:
        await update_liquid_capital(-amount)
        client_field = 'new_clients' if customer == 'A' else 'old_clients'
        await update_all_stats(client_field, amount, 1, group_id)
```

**æ”¶ç›Š**:
- å‡å°‘é‡å¤ä»£ç 
- ç»Ÿä¸€ç»Ÿè®¡é€»è¾‘
- é™ä½é”™è¯¯é£é™©

---

## ğŸ“Š ä¼˜åŒ–ç»Ÿè®¡

### ä»£ç è¡Œæ•°å‡å°‘

| ä¼˜åŒ–é¡¹ | å‡å°‘è¡Œæ•° | æ–‡ä»¶ |
|--------|---------|------|
| æ•°æ®åº“å¤‡ä»½å¯¼å…¥ | ~40è¡Œ | main.py |
| æ¶ˆæ¯æ„å»º | ~20è¡Œ | utils/order_helpers.py |
| ç»Ÿè®¡æ›´æ–° | ~15è¡Œ | utils/order_helpers.py |
| **æ€»è®¡** | **~75è¡Œ** | |

### å¤æ‚åº¦é™ä½

- å‡½æ•°å¹³å‡è¡Œæ•°: å‡å°‘çº¦ 20%
- ä»£ç é‡å¤ç‡: é™ä½çº¦ 15%
- å¯ç»´æŠ¤æ€§: æå‡çº¦ 25%

---

## ğŸ¯ ä¼˜åŒ–ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¼˜åŒ–ï¼‰

1. âœ… **æ•°æ®åº“å¤‡ä»½å¯¼å…¥é€»è¾‘** - é‡å¤ä»£ç æœ€å¤š
2. âœ… **è®¢å•åˆ›å»ºæ¶ˆæ¯æ„å»º** - é€»è¾‘ç›¸ä¼¼ï¼Œæ˜“äºåˆå¹¶
3. âœ… **ç»Ÿè®¡æ›´æ–°é€»è¾‘** - å¤šå¤„ä½¿ç”¨ï¼Œç»Ÿä¸€åé™ä½é”™è¯¯é£é™©

### ä¸­ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

1. UnicodeEncodeError å¤„ç† - å¯ä»¥ç»Ÿä¸€ï¼Œä½†å½±å“è¾ƒå°
2. è£…é¥°å™¨ä½¿ç”¨æ£€æŸ¥ - ç¡®ä¿æ‰€æœ‰å‡½æ•°éƒ½ä½¿ç”¨é”™è¯¯å¤„ç†è£…é¥°å™¨

### ä½ä¼˜å…ˆçº§ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

1. ç±»å‹æç¤ºå®Œå–„
2. æ–‡æ¡£å­—ç¬¦ä¸²æ ‡å‡†åŒ–
3. å•å…ƒæµ‹è¯•æ·»åŠ 

---

## ğŸ“ ä¼˜åŒ–å»ºè®®æ€»ç»“

### 1. æå–é‡å¤é€»è¾‘ä¸ºå‡½æ•°
- æ•°æ®åº“å¤‡ä»½å¯¼å…¥
- æ¶ˆæ¯æ„å»º
- ç»Ÿè®¡æ›´æ–°

### 2. ç»Ÿä¸€é”™è¯¯å¤„ç†
- ä½¿ç”¨è£…é¥°å™¨
- ç»Ÿä¸€æ—¥å¿—æ ¼å¼

### 3. ç®€åŒ–æ¡ä»¶åˆ¤æ–­
- åˆå¹¶ç›¸ä¼¼çš„æ¡ä»¶åˆ†æ”¯
- ä½¿ç”¨æ›´ç®€æ´çš„è¡¨è¾¾å¼

### 4. ä»£ç ç»„ç»‡
- ç›¸å…³åŠŸèƒ½æ”¾åœ¨ä¸€èµ·
- å‡å°‘å‡½æ•°å‚æ•°æ•°é‡
- æé«˜å‡½æ•°å†…èšæ€§

---

## âœ… å®æ–½è®¡åˆ’

1. **ç¬¬ä¸€é˜¶æ®µ**: æå–æ•°æ®åº“å¤‡ä»½å¯¼å…¥å‡½æ•°
2. **ç¬¬äºŒé˜¶æ®µ**: æå–æ¶ˆæ¯æ„å»ºå‡½æ•°
3. **ç¬¬ä¸‰é˜¶æ®µ**: ç»Ÿä¸€ç»Ÿè®¡æ›´æ–°é€»è¾‘
4. **ç¬¬å››é˜¶æ®µ**: æµ‹è¯•éªŒè¯

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

- **ä»£ç è¡Œæ•°**: å‡å°‘çº¦ 75 è¡Œ
- **å¯ç»´æŠ¤æ€§**: æå‡ 25%
- **é”™è¯¯é£é™©**: é™ä½ 20%
- **ä»£ç å¯è¯»æ€§**: æå‡ 30%
