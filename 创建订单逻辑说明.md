# åˆ›å»ºè®¢å•é€»è¾‘è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

è®¢å•åˆ›å»ºåŠŸèƒ½å…è®¸ä» Telegram ç¾¤ç»„åç§°è‡ªåŠ¨è§£æå¹¶åˆ›å»ºè®¢å•ã€‚æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆ`/create` å‘½ä»¤ï¼‰å’Œè‡ªåŠ¨è§¦å‘ï¼ˆç¾¤ç»„æ”¹åäº‹ä»¶ï¼‰ã€‚

---

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è§¦å‘æ–¹å¼                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æ‰‹åŠ¨è§¦å‘: /create å‘½ä»¤                              â”‚
â”‚  2. è‡ªåŠ¨è§¦å‘: ç¾¤ç»„æ”¹åäº‹ä»¶                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              1. è§£æç¾¤ç»„åç§°                             â”‚
â”‚  - æå–è®¢å•IDã€å®¢æˆ·ç±»å‹ã€æ—¥æœŸã€é‡‘é¢                      â”‚
â”‚  - éªŒè¯æ ¼å¼æ˜¯å¦æ­£ç¡®                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          2. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®¢å•                           â”‚
â”‚  - æŸ¥è¯¢å½“å‰ç¾¤ç»„æ˜¯å¦å·²æœ‰æ´»è·ƒè®¢å•                          â”‚
â”‚  - å¦‚æœå­˜åœ¨ï¼š                                            â”‚
â”‚    â€¢ æ‰‹åŠ¨è§¦å‘ â†’ æç¤ºå·²å­˜åœ¨                               â”‚
â”‚    â€¢ è‡ªåŠ¨è§¦å‘ â†’ å°è¯•æ›´æ–°è®¢å•çŠ¶æ€                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          3. æå–è®¢å•ä¿¡æ¯                                â”‚
â”‚  - è®¢å•æ—¥æœŸã€é‡‘é¢ã€è®¢å•IDã€å®¢æˆ·ç±»å‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          4. è¯†åˆ«åˆå§‹çŠ¶æ€                                 â”‚
â”‚  - æ ¹æ®ç¾¤åä¸­çš„æ ‡å¿—è¯†åˆ«çŠ¶æ€                              â”‚
â”‚  - âŒ â†’ breach (è¿çº¦)                                   â”‚
â”‚  - â—ï¸ â†’ overdue (é€¾æœŸ)                                  â”‚
â”‚  - å…¶ä»– â†’ normal (æ­£å¸¸)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          5. æ£€æŸ¥æ—¥æœŸé˜ˆå€¼                                 â”‚
â”‚  - 2025-11-25ä¹‹å‰çš„è®¢å• â†’ å†å²è®¢å•ï¼ˆä¸æ‰£æ¬¾ï¼‰            â”‚
â”‚  - 2025-11-25ä¹‹åçš„è®¢å• â†’ æ­£å¸¸è®¢å•ï¼ˆæ‰£æ¬¾ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          6. æ£€æŸ¥ä½™é¢ï¼ˆä»…éå†å²è®¢å•ï¼‰                     â”‚
â”‚  - æŸ¥è¯¢æµåŠ¨èµ„é‡‘ä½™é¢                                      â”‚
â”‚  - å¦‚æœä½™é¢ä¸è¶³ â†’ è¿”å›é”™è¯¯ï¼Œä¸åˆ›å»ºè®¢å•                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          7. æ„å»ºè®¢å•æ•°æ®                                 â”‚
â”‚  - è®¢å•IDã€å½’å±IDã€ç¾¤ç»„IDã€æ—¥æœŸ                          â”‚
â”‚  - æ˜ŸæœŸåˆ†ç»„ã€å®¢æˆ·ç±»å‹ã€é‡‘é¢ã€çŠ¶æ€                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          8. åˆ›å»ºè®¢å•ï¼ˆæ•°æ®åº“ï¼‰                           â”‚
â”‚  - æ’å…¥ orders è¡¨                                        â”‚
â”‚  - å¦‚æœè®¢å•IDé‡å¤ â†’ è¿”å›é”™è¯¯                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          9. æ›´æ–°ç»Ÿè®¡æ•°æ®                                 â”‚
â”‚  â”œâ”€ æ­£å¸¸è®¢å•æµç¨‹ï¼ˆéå†å²ï¼‰:                              â”‚
â”‚  â”‚  â€¢ æ›´æ–°æœ‰æ•ˆè®¢å•ç»Ÿè®¡ï¼ˆæˆ–è¿çº¦è®¢å•ç»Ÿè®¡ï¼‰                 â”‚
â”‚  â”‚  â€¢ æ‰£é™¤æµåŠ¨èµ„é‡‘                                        â”‚
â”‚  â”‚  â€¢ æ›´æ–°å®¢æˆ·ç»Ÿè®¡ï¼ˆæ–°å®¢æˆ·/è€å®¢æˆ·ï¼‰                       â”‚
â”‚  â””â”€ å†å²è®¢å•æµç¨‹:                                        â”‚
â”‚     â€¢ ä»…æ›´æ–°ç»Ÿè®¡ï¼Œä¸æ‰£æ¬¾                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          10. å‘é€ç¡®è®¤æ¶ˆæ¯                                â”‚
â”‚  - æ˜¾ç¤ºè®¢å•åˆ›å»ºæˆåŠŸä¿¡æ¯                                  â”‚
â”‚  - åŒ…å«è®¢å•IDã€é‡‘é¢ã€çŠ¶æ€ç­‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          11. è‡ªåŠ¨æ’­æŠ¥ä¸‹ä¸€æœŸè¿˜æ¬¾                          â”‚
â”‚  - åŸºäºè®¢å•æ—¥æœŸè®¡ç®—ä¸‹ä¸ªä»˜æ¬¾æ—¥æœŸ                          â”‚
â”‚  - å‘é€æ’­æŠ¥æ¶ˆæ¯åˆ°ç¾¤ç»„                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ è¯¦ç»†æ­¥éª¤è¯´æ˜

### æ­¥éª¤ 1: è§¦å‘æ–¹å¼

#### 1.1 æ‰‹åŠ¨è§¦å‘
- **å‘½ä»¤**: `/create`
- **ä½ç½®**: `handlers/command_handlers.py::create_order()`
- **æƒé™**: æˆæƒç”¨æˆ·ï¼Œä»…ç¾¤ç»„
- **æµç¨‹**: è¯»å–ç¾¤ç»„åç§°ï¼Œè°ƒç”¨ `try_create_order_from_title()`

#### 1.2 è‡ªåŠ¨è§¦å‘
- **äº‹ä»¶**: ç¾¤ç»„æ”¹åï¼ˆ`handle_new_chat_title`ï¼‰
- **ä½ç½®**: `handlers/message_handlers.py`
- **æµç¨‹**: æ£€æµ‹åˆ°ç¾¤ç»„æ”¹åï¼Œè‡ªåŠ¨å°è¯•åˆ›å»ºè®¢å•

---

### æ­¥éª¤ 2: è§£æç¾¤ç»„åç§°

#### 2.1 ç¾¤åæ ¼å¼

**è€å®¢æˆ·æ ¼å¼**:
```
10ä½æ•°å­—: YYMMDDNNKK
ç¤ºä¾‹: 2506060110
```

**æ–°å®¢æˆ·æ ¼å¼**:
```
A + 10ä½æ•°å­—: AYYMMDDNNKK
ç¤ºä¾‹: A2506060110
```

#### 2.2 è§£æè§„åˆ™

**ä½ç½®**: `utils/order_helpers.py::parse_order_from_title()`

```python
# è§£æ10ä½æ•°å­—
date_part = raw_digits[:6]      # YYMMDD (æ—¥æœŸ)
seq_part = raw_digits[6:8]      # NN (åºå·)
amount_part = raw_digits[8:10]  # KK (é‡‘é¢ï¼Œå•ä½ï¼šåƒ)

# è§£ææ—¥æœŸ
full_date_str = f"20{date_part}"  # 20250606
order_date = datetime.strptime(full_date_str, "%Y%m%d").date()

# è§£æé‡‘é¢
amount = int(amount_part) * 1000  # 10 * 1000 = 10,000
```

#### 2.3 è§£æç»“æœ

```python
{
    'date': order_date_obj,        # è®¢å•æ—¥æœŸå¯¹è±¡
    'amount': amount,              # è®¢å•é‡‘é¢
    'order_id': order_id,          # è®¢å•IDï¼ˆå®Œæ•´å­—ç¬¦ä¸²ï¼‰
    'customer': customer,           # å®¢æˆ·ç±»å‹ ('A' æˆ– 'B')
    'full_date_str': full_date_str # å®Œæ•´æ—¥æœŸå­—ç¬¦ä¸²
}
```

---

### æ­¥éª¤ 3: æ£€æŸ¥å·²å­˜åœ¨è®¢å•

**ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`

```python
existing_order = await db_operations.get_order_by_chat_id(chat_id)
if existing_order:
    if manual_trigger:
        # æ‰‹åŠ¨è§¦å‘ï¼šæç¤ºå·²å­˜åœ¨
        await update.message.reply_text("âš ï¸ Order already exists in this group.")
    else:
        # è‡ªåŠ¨è§¦å‘ï¼šå°è¯•æ›´æ–°è®¢å•çŠ¶æ€
        await update_order_state_from_title(update, context, existing_order, title)
    return
```

**è¯´æ˜**:
- æ¯ä¸ªç¾¤ç»„åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒè®¢å•ï¼ˆçŠ¶æ€ä¸æ˜¯ `end` æˆ– `breach_end`ï¼‰
- å¦‚æœå·²å­˜åœ¨è®¢å•ï¼Œæ‰‹åŠ¨è§¦å‘ä¼šæç¤ºé”™è¯¯
- è‡ªåŠ¨è§¦å‘ä¼šå°è¯•æ ¹æ®æ–°ç¾¤åæ›´æ–°è®¢å•çŠ¶æ€

---

### æ­¥éª¤ 4: è¯†åˆ«åˆå§‹çŠ¶æ€

**ä½ç½®**: `utils/order_helpers.py::get_state_from_title()`

**è§„åˆ™**:
- ç¾¤ååŒ…å« `âŒ` â†’ `breach` (è¿çº¦)
- ç¾¤ååŒ…å« `â—ï¸` â†’ `overdue` (é€¾æœŸ)
- å…¶ä»–æƒ…å†µ â†’ `normal` (æ­£å¸¸)

**ä»£ç **:
```python
def get_state_from_title(title: str) -> str:
    if 'âŒ' in title:
        return 'breach'
    elif 'â—ï¸' in title:
        return 'overdue'
    else:
        return 'normal'
```

---

### æ­¥éª¤ 5: æ£€æŸ¥æ—¥æœŸé˜ˆå€¼

**ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`

**è§„åˆ™**:
- **å†å²è®¢å•**: è®¢å•æ—¥æœŸ < 2025-11-25
  - ä¸æ‰£æ¬¾
  - ä»…æ›´æ–°ç»Ÿè®¡
  - æ ‡è®°ä¸ºå†å²æ•°æ®

- **æ­£å¸¸è®¢å•**: è®¢å•æ—¥æœŸ >= 2025-11-25
  - æ­£å¸¸æ‰£æ¬¾æµç¨‹
  - æ£€æŸ¥ä½™é¢
  - æ‰£é™¤æµåŠ¨èµ„é‡‘

**ä»£ç **:
```python
threshold_date = date(*HISTORICAL_THRESHOLD_DATE)  # 2025-11-25
is_historical = order_date < threshold_date
```

---

### æ­¥éª¤ 6: æ£€æŸ¥ä½™é¢ï¼ˆä»…éå†å²è®¢å•ï¼‰

**ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`

**é€»è¾‘**:
```python
if not is_historical:
    financial_data = await db_operations.get_financial_data()
    if financial_data['liquid_funds'] < amount:
        # ä½™é¢ä¸è¶³ï¼Œè¿”å›é”™è¯¯
        await update.message.reply_text(
            f"âŒ Insufficient Liquid Funds\n"
            f"Current Balance: {financial_data['liquid_funds']:.2f}\n"
            f"Required: {amount:.2f}\n"
            f"Missing: {amount - financial_data['liquid_funds']:.2f}"
        )
        return
```

**è¯´æ˜**:
- ä»…å¯¹éå†å²è®¢å•æ£€æŸ¥ä½™é¢
- å¦‚æœä½™é¢ä¸è¶³ï¼Œä¸åˆ›å»ºè®¢å•
- æ˜¾ç¤ºå½“å‰ä½™é¢ã€æ‰€éœ€é‡‘é¢ã€ç¼ºå°‘é‡‘é¢

---

### æ­¥éª¤ 7: æ„å»ºè®¢å•æ•°æ®

**ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`

**è®¢å•æ•°æ®ç»“æ„**:
```python
new_order = {
    'order_id': order_id,           # è®¢å•IDï¼ˆä»ç¾¤åè§£æï¼‰
    'group_id': 'S01',              # å½’å±IDï¼ˆé»˜è®¤ï¼‰
    'chat_id': chat_id,             # ç¾¤ç»„ID
    'date': created_at,             # è®¢å•æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SSï¼‰
    'group': weekday_group,         # æ˜ŸæœŸåˆ†ç»„ï¼ˆä¸€ã€äºŒã€ä¸‰...ï¼‰
    'customer': customer,           # å®¢æˆ·ç±»å‹ï¼ˆ'A' æˆ– 'B'ï¼‰
    'amount': amount,               # è®¢å•é‡‘é¢
    'state': initial_state          # åˆå§‹çŠ¶æ€
}
```

**æ—¥æœŸæ ¼å¼**:
```python
created_at = f"{order_date.strftime('%Y-%m-%d')} 12:00:00"
# ç¤ºä¾‹: "2025-06-06 12:00:00"
```

---

### æ­¥éª¤ 8: åˆ›å»ºè®¢å•ï¼ˆæ•°æ®åº“ï¼‰

**ä½ç½®**: `db_operations.py::create_order()`

**æ•°æ®åº“æ“ä½œ**:
```python
@db_transaction
def create_order(conn, cursor, order_data: Dict) -> bool:
    cursor.execute('''
    INSERT INTO orders (
        order_id, group_id, chat_id, date, weekday_group,
        customer, amount, state
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        order_data['order_id'],
        order_data['group_id'],
        order_data['chat_id'],
        order_data['date'],
        order_data['group'],
        order_data['customer'],
        order_data['amount'],
        order_data['state']
    ))
    return True
```

**é”™è¯¯å¤„ç†**:
- å¦‚æœè®¢å•IDé‡å¤ï¼ˆ`sqlite3.IntegrityError`ï¼‰ï¼Œè¿”å› `False`
- äº‹åŠ¡ç”± `@db_transaction` è£…é¥°å™¨è‡ªåŠ¨å¤„ç†

---

### æ­¥éª¤ 9: æ›´æ–°ç»Ÿè®¡æ•°æ®

#### 9.1 æ­£å¸¸è®¢å•æµç¨‹ï¼ˆéå†å²ï¼‰

**ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`

**æ›´æ–°å†…å®¹**:
```python
# 1. æ›´æ–°æœ‰æ•ˆè®¢å•ç»Ÿè®¡ï¼ˆæˆ–è¿çº¦è®¢å•ç»Ÿè®¡ï¼‰
if is_initial_breach:
    await update_all_stats('breach', amount, 1, group_id)
else:
    await update_all_stats('valid', amount, 1, group_id)

# 2. æ‰£é™¤æµåŠ¨èµ„é‡‘
await update_liquid_capital(-amount)

# 3. æ›´æ–°å®¢æˆ·ç»Ÿè®¡
client_field = 'new_clients' if customer == 'A' else 'old_clients'
await update_all_stats(client_field, amount, 1, group_id)
```

**ç»Ÿè®¡å±‚çº§**:
- **å…¨å±€ç»Ÿè®¡** (`financial_data` è¡¨)
- **åˆ†ç»„ç»Ÿè®¡** (`grouped_data` è¡¨)
- **æ—¥ç»“ç»Ÿè®¡** (`daily_data` è¡¨)

#### 9.2 å†å²è®¢å•æµç¨‹

**ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`

**æ›´æ–°å†…å®¹**:
```python
# ä»…æ›´æ–°ç»Ÿè®¡ï¼Œä¸æ‰£æ¬¾
if is_initial_breach:
    await update_all_stats('breach', amount, 1, group_id)
else:
    await update_all_stats('valid', amount, 1, group_id)
```

**è¯´æ˜**:
- å†å²è®¢å•ä¸æ‰£é™¤æµåŠ¨èµ„é‡‘
- ä»…æ›´æ–°ç»Ÿè®¡æ•°æ®
- ç”¨äºå†å²æ•°æ®å¯¼å…¥

---

### æ­¥éª¤ 10: å‘é€ç¡®è®¤æ¶ˆæ¯

**ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`

**æ­£å¸¸è®¢å•æ¶ˆæ¯**:
```
âœ… Order Created Successfully

ğŸ“‹ Order ID: 2506060110
ğŸ·ï¸ Group ID: S01
ğŸ“… Date: 2025-06-06 12:00:00
ğŸ‘¥ Week Group: å››
ğŸ‘¤ Customer: Returning
ğŸ’° Amount: 10000.00
ğŸ“ˆ Status: normal
```

**å†å²è®¢å•æ¶ˆæ¯**:
```
âœ… Historical Order Imported

ğŸ“‹ Order ID: 2506060110
ğŸ·ï¸ Group ID: S01
ğŸ“… Date: 2025-06-06 12:00:00
ğŸ‘¤ Customer: Returning (Historical)
ğŸ’° Amount: 10000.00
ğŸ“ˆ Status: normal
âš ï¸ Funds Update: Skipped (Historical Data Only)
```

---

### æ­¥éª¤ 11: è‡ªåŠ¨æ’­æŠ¥ä¸‹ä¸€æœŸè¿˜æ¬¾

**ä½ç½®**: `utils/order_helpers.py::send_auto_broadcast()`

**é€»è¾‘**:
```python
# åŸºäºè®¢å•æ—¥æœŸè®¡ç®—ä¸‹ä¸ªä»˜æ¬¾æ—¥æœŸ
_, date_str, weekday_str = calculate_next_payment_date(order_date)

# ç”Ÿæˆæ’­æŠ¥æ¶ˆæ¯
message = format_broadcast_message(
    principal=amount,
    principal_12=amount * 0.12,
    outstanding_interest=0,
    date_str=date_str,
    weekday_str=weekday_str
)

# å‘é€åˆ°ç¾¤ç»„
await context.bot.send_message(chat_id=chat_id, text=message)
```

**æ’­æŠ¥æ¶ˆæ¯ç¤ºä¾‹**:
```
Your next payment is due on December 05,2025 (Friday) for 10,000 or 1,200 to defer the principal payment for one week.

Your outstanding interest is 0
```

**è¯´æ˜**:
- è®¢å•åˆ›å»ºæˆåŠŸåè‡ªåŠ¨å‘é€æ’­æŠ¥
- å†å²è®¢å•ä¹Ÿä¼šè‡ªåŠ¨æ’­æŠ¥
- æ’­æŠ¥å¤±è´¥ä¸å½±å“è®¢å•åˆ›å»ºï¼ˆé™é»˜å¤±è´¥ï¼‰

---

## ğŸ” å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | å‡½æ•° |
|------|------|------|
| æ‰‹åŠ¨è§¦å‘ | `handlers/command_handlers.py` | `create_order()` |
| è‡ªåŠ¨è§¦å‘ | `handlers/message_handlers.py` | `handle_new_chat_title()` |
| æ ¸å¿ƒé€»è¾‘ | `utils/order_helpers.py` | `try_create_order_from_title()` |
| ç¾¤åè§£æ | `utils/order_helpers.py` | `parse_order_from_title()` |
| çŠ¶æ€è¯†åˆ« | `utils/order_helpers.py` | `get_state_from_title()` |
| æ•°æ®åº“æ“ä½œ | `db_operations.py` | `create_order()` |
| ç»Ÿè®¡æ›´æ–° | `utils/stats_helpers.py` | `update_all_stats()` |
| è‡ªåŠ¨æ’­æŠ¥ | `utils/order_helpers.py` | `send_auto_broadcast()` |

---

## âš ï¸ é‡è¦è§„åˆ™

### 1. ç¾¤åæ ¼å¼è¦æ±‚
- **è€å®¢æˆ·**: 10ä½æ•°å­— `YYMMDDNNKK`
- **æ–°å®¢æˆ·**: `A` + 10ä½æ•°å­— `AYYMMDDNNKK`
- æ ¼å¼ä¸æ­£ç¡® â†’ ä¸åˆ›å»ºè®¢å•

### 2. è®¢å•å”¯ä¸€æ€§
- æ¯ä¸ªç¾¤ç»„åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒè®¢å•
- è®¢å•IDå¿…é¡»å”¯ä¸€
- å¦‚æœè®¢å•IDé‡å¤ â†’ åˆ›å»ºå¤±è´¥

### 3. ä½™é¢æ£€æŸ¥
- ä»…å¯¹éå†å²è®¢å•æ£€æŸ¥ä½™é¢
- ä½™é¢ä¸è¶³ â†’ ä¸åˆ›å»ºè®¢å•
- å†å²è®¢å•ä¸æ£€æŸ¥ä½™é¢

### 4. æ—¥æœŸé˜ˆå€¼
- **2025-11-25ä¹‹å‰**: å†å²è®¢å•ï¼ˆä¸æ‰£æ¬¾ï¼‰
- **2025-11-25ä¹‹å**: æ­£å¸¸è®¢å•ï¼ˆæ‰£æ¬¾ï¼‰

### 5. çŠ¶æ€è¯†åˆ«
- `âŒ` â†’ `breach` (è¿çº¦)
- `â—ï¸` â†’ `overdue` (é€¾æœŸ)
- å…¶ä»– â†’ `normal` (æ­£å¸¸)

---

## ğŸ“Š æ•°æ®æµ

```
ç¾¤ç»„åç§°
  â†“
è§£æè®¢å•ä¿¡æ¯ (æ—¥æœŸã€é‡‘é¢ã€å®¢æˆ·ç±»å‹)
  â†“
æ£€æŸ¥å·²å­˜åœ¨è®¢å•
  â†“
è¯†åˆ«åˆå§‹çŠ¶æ€
  â†“
æ£€æŸ¥æ—¥æœŸé˜ˆå€¼ â†’ åˆ¤æ–­æ˜¯å¦ä¸ºå†å²è®¢å•
  â†“
æ£€æŸ¥ä½™é¢ï¼ˆä»…éå†å²è®¢å•ï¼‰
  â†“
æ„å»ºè®¢å•æ•°æ®
  â†“
æ’å…¥æ•°æ®åº“ (orders è¡¨)
  â†“
æ›´æ–°ç»Ÿè®¡æ•°æ® (financial_data, grouped_data, daily_data)
  â†“
æ‰£é™¤æµåŠ¨èµ„é‡‘ï¼ˆä»…éå†å²è®¢å•ï¼‰
  â†“
å‘é€ç¡®è®¤æ¶ˆæ¯
  â†“
è‡ªåŠ¨æ’­æŠ¥ä¸‹ä¸€æœŸè¿˜æ¬¾
```

---

## âœ… æ€»ç»“

åˆ›å»ºè®¢å•çš„å®Œæ•´æµç¨‹åŒ…æ‹¬ï¼š
1. âœ… **è§¦å‘** - æ‰‹åŠ¨å‘½ä»¤æˆ–è‡ªåŠ¨äº‹ä»¶
2. âœ… **è§£æ** - ä»ç¾¤åæå–è®¢å•ä¿¡æ¯
3. âœ… **éªŒè¯** - æ£€æŸ¥å·²å­˜åœ¨è®¢å•ã€ä½™é¢ã€æ ¼å¼
4. âœ… **åˆ›å»º** - æ’å…¥æ•°æ®åº“
5. âœ… **ç»Ÿè®¡** - æ›´æ–°ä¸‰å±‚ç»Ÿè®¡æ•°æ®
6. âœ… **æ‰£æ¬¾** - æ‰£é™¤æµåŠ¨èµ„é‡‘ï¼ˆä»…éå†å²è®¢å•ï¼‰
7. âœ… **é€šçŸ¥** - å‘é€ç¡®è®¤æ¶ˆæ¯å’Œè‡ªåŠ¨æ’­æŠ¥

æ•´ä¸ªæµç¨‹è®¾è®¡åˆç†ï¼Œæ”¯æŒå†å²æ•°æ®å¯¼å…¥å’Œæ­£å¸¸è®¢å•åˆ›å»ºï¼Œå¹¶è‡ªåŠ¨å¤„ç†ç»Ÿè®¡å’Œæ’­æŠ¥ã€‚

