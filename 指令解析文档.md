# 订单管理机器人 - 指令解析文档

## 📋 目录
1. [基础命令](#基础命令)
2. [订单操作命令](#订单操作命令)
3. [快捷操作](#快捷操作)
4. [状态变更命令](#状态变更命令)
5. [查询命令](#查询命令)
6. [管理命令](#管理命令)
7. [自动事件处理](#自动事件处理)
8. [回调按钮](#回调按钮)

---

## 基础命令

### `/start`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅私聊
- **参数**: 无
- **功能**: 显示欢迎消息和所有可用命令的帮助信息
- **处理文件**: `handlers/command_handlers.py:start()`
- **说明**: 显示当前流动资金和完整的命令列表

---

## 订单操作命令

### `/create`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅群组
- **参数**: 无（自动读取群名）
- **功能**: 从群名解析并创建新订单
- **处理文件**: `handlers/command_handlers.py:create_order()`
- **群名格式**:
  - 新客户: `A2401150105` (A + 10位数字)
  - 老客户: `2401150105` (10位数字)
- **解析规则**:
  - 前6位: 日期 (YYMMDD)
  - 后2位: 金额 (KK * 1000)
- **状态识别**:
  - `❌` 在群名中 → `breach`
  - `❗️` 在群名中 → `overdue`
  - 其他 → `normal`

### `/order`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅群组
- **参数**: 无
- **功能**: 显示当前群组的订单状态和操作菜单
- **处理文件**: `handlers/command_handlers.py:show_current_order()`
- **显示内容**:
  - 订单ID、归属ID、日期
  - 星期分组、客户类型、金额、状态
  - 操作按钮（Normal/Overdue/End/Breach/Breach End）

---

## 快捷操作

### `+<金额>`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅群组
- **格式**: `+1000` 或 `+1000.50`
- **功能**: 记录利息收入
- **处理文件**: `handlers/amount_handlers.py:handle_amount_operation()`
- **逻辑**:
  - 如果有订单，关联到订单的归属ID
  - 如果没有订单，更新全局和日结数据
  - 增加流动资金

### `+<金额>b`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅群组
- **格式**: `+1000b` 或 `+1000.50b`
- **功能**: 减少本金
- **处理文件**: `handlers/amount_handlers.py:process_principal_reduction()`
- **要求**:
  - 订单状态必须是 `normal` 或 `overdue`
  - 金额必须为正数
  - 金额不能超过订单金额
- **逻辑**:
  - 更新订单金额（减少）
  - 有效金额减少，完成金额增加
  - 流动资金增加

---

## 状态变更命令

### `/normal`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅群组
- **参数**: 无
- **功能**: 将订单从逾期转为正常
- **处理文件**: `handlers/order_handlers.py:set_normal()`
- **要求**: 订单状态必须是 `overdue`

### `/overdue`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅群组
- **参数**: 无
- **功能**: 将订单从正常转为逾期
- **处理文件**: `handlers/order_handlers.py:set_overdue()`
- **要求**: 订单状态必须是 `normal`

### `/end`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅群组
- **参数**: 无
- **功能**: 标记订单为完成
- **处理文件**: `handlers/order_handlers.py:set_end()`
- **要求**: 订单状态必须是 `normal` 或 `overdue`
- **逻辑**:
  - 有效订单减少，完成订单增加
  - 流动资金增加（回款）

### `/breach`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅群组
- **参数**: 无
- **功能**: 标记订单为违约
- **处理文件**: `handlers/order_handlers.py:set_breach()`
- **要求**: 订单状态必须是 `overdue`
- **逻辑**:
  - 有效订单减少，违约订单增加

### `/breach_end [金额]`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅群组
- **参数**: 可选，金额（如：`/breach_end 5000`）
- **功能**: 违约订单完成
- **处理文件**: `handlers/order_handlers.py:set_breach_end()`
- **要求**: 订单状态必须是 `breach`
- **逻辑**:
  - 如果提供金额参数，直接完成
  - 如果没有参数，进入交互模式，等待用户输入金额
  - 违约完成订单增加，流动资金增加

---

## 查询命令

### `/report [归属ID]`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅私聊
- **参数**: 可选，归属ID（如：`/report S01`）
- **功能**: 显示报表（今日/本月/自定义日期范围）
- **处理文件**: `handlers/report_handlers.py:show_report()`
- **报表内容**:
  - 当前状态（有效订单数/金额）
  - 周期数据（流动资金、新/老客户、利息、完成订单、违约订单等）
  - 开销与余额
- **交互按钮**:
  - 月报、日期查询
  - 公司开销、其他开销
  - 搜索与锁定、群发

### `/search [类型] [值]`
- **权限**: 授权用户（管理员或员工）
- **场景**: 仅私聊
- **参数**: 
  - 无参数：显示交互式搜索菜单
  - 有参数：`/search <类型> <值> [值2]`
- **功能**: 搜索订单
- **处理文件**: `handlers/search_handlers.py:search_orders()`
- **搜索类型**:
  - `order_id`: 按订单ID搜索
    - 格式: `/search order_id 2401150105`
  - `group_id`: 按归属ID搜索
    - 格式: `/search group_id S01`
  - `customer`: 按客户类型搜索
    - 格式: `/search customer A` 或 `/search customer B`
  - `state`: 按状态搜索
    - 格式: `/search state normal`
    - 可选值: `normal`, `overdue`, `breach`, `end`, `breach_end`
  - `date`: 按日期范围搜索
    - 格式: `/search date 2024-01-01 2024-01-31`
  - `group`: 按星期分组搜索
    - 格式: `/search group 一` 或 `/search group 周一`
- **交互式搜索**:
  - 支持按状态、归属ID、星期分组搜索
  - 搜索结果会锁定群组，可用于群发

---

## 管理命令（仅管理员）

### `/adjust <金额> [备注]`
- **权限**: 仅管理员
- **场景**: 仅私聊
- **参数**: 
  - 金额：`+5000` 或 `-3000`（必须带+/-）
  - 备注：可选
- **功能**: 调整流动资金余额
- **处理文件**: `handlers/command_handlers.py:adjust_funds()`
- **示例**:
  - `/adjust +5000 收入备注`
  - `/adjust -3000 支出备注`

### `/create_attribution <归属ID>`
- **权限**: 仅管理员
- **场景**: 仅私聊
- **参数**: 归属ID（格式：字母+两位数字，如 `S01`）
- **功能**: 创建新的归属ID
- **处理文件**: `handlers/command_handlers.py:create_attribution()`
- **示例**: `/create_attribution S03`

### `/list_attributions`
- **权限**: 仅管理员
- **场景**: 仅私聊
- **参数**: 无
- **功能**: 列出所有归属ID及其统计信息
- **处理文件**: `handlers/command_handlers.py:list_attributions()`

### `/add_employee <用户ID>`
- **权限**: 仅管理员
- **场景**: 仅私聊
- **参数**: 用户ID（数字）
- **功能**: 添加授权员工
- **处理文件**: `handlers/command_handlers.py:add_employee()`
- **示例**: `/add_employee 123456789`

### `/remove_employee <用户ID>`
- **权限**: 仅管理员
- **场景**: 仅私聊
- **参数**: 用户ID（数字）
- **功能**: 移除授权员工
- **处理文件**: `handlers/command_handlers.py:remove_employee()`
- **示例**: `/remove_employee 123456789`

### `/list_employees`
- **权限**: 仅管理员
- **场景**: 仅私聊
- **参数**: 无
- **功能**: 列出所有授权员工
- **处理文件**: `handlers/command_handlers.py:list_employees()`

---

## 自动事件处理

### 机器人入群
- **触发**: 机器人被添加到群组
- **处理文件**: `handlers/message_handlers.py:handle_new_chat_members()`
- **功能**: 自动尝试从群名创建订单
- **逻辑**: 解析群名，如果符合订单格式则创建订单

### 群名变更
- **触发**: 群组名称被修改
- **处理文件**: `handlers/message_handlers.py:handle_new_chat_title()`
- **功能**: 
  - 如果订单已存在，根据新群名更新订单状态
  - 如果订单不存在，尝试创建新订单
- **状态更新规则**:
  - `normal/overdue` ↔ `breach`: 移动统计数据
  - `normal` ↔ `overdue`: 仅更新状态（都在Valid统计下）

---

## 回调按钮

### 订单操作回调 (`order_action_*`)
- **权限**: 授权用户（管理员或员工）
- **处理文件**: `callbacks/order_callbacks.py:handle_order_action_callback()`
- **回调数据**:
  - `order_action_normal`: 转为正常
  - `order_action_overdue`: 转为逾期
  - `order_action_end`: 标记完成
  - `order_action_breach`: 标记违约
  - `order_action_breach_end`: 违约完成

### 报表回调 (`report_*`)
- **权限**: 授权用户（管理员或员工）
- **处理文件**: `callbacks/report_callbacks.py:handle_report_callback()`
- **主要回调**:
  - `report_view_today_*`: 今日报表
  - `report_view_month_*`: 月报
  - `report_view_query_*`: 日期查询
  - `report_record_company`: 公司开销
  - `report_record_other`: 其他开销
  - `report_add_expense_*`: 添加开销
  - `report_expense_month_*`: 月开销
  - `report_expense_query_*`: 开销查询
  - `report_menu_attribution`: 归属ID选择

### 搜索回调 (`search_*`)
- **权限**: 授权用户（管理员或员工）
- **处理文件**: `callbacks/search_callbacks.py:handle_search_callback()`
- **主要回调**:
  - `search_start`: 搜索主菜单
  - `search_menu_state`: 按状态搜索菜单
  - `search_menu_attribution`: 按归属ID搜索菜单
  - `search_menu_group`: 按星期分组搜索菜单
  - `search_lock_start`: 开始搜索并锁定
  - `search_do_state_*`: 执行状态搜索
  - `search_do_attribution_*`: 执行归属ID搜索
  - `search_do_group_*`: 执行星期分组搜索

### 其他回调
- **处理文件**: `callbacks/main_callback.py:button_callback()`
- **回调数据**:
  - `broadcast_start`: 开始群发消息

---

## 文本输入处理

### 搜索输入 (`SEARCHING`)
- **触发**: 在搜索锁定模式下输入搜索条件
- **处理文件**: `handlers/message_handlers.py:_handle_search_input()`
- **格式**:
  - `key=value` 格式: `group_id=S01 state=normal`
  - 智能识别: 直接输入值（如 `S01`, `normal`, `一` 等）

### 报表查询输入 (`REPORT_QUERY`)
- **触发**: 在报表日期查询模式下输入日期
- **处理文件**: `handlers/message_handlers.py:_handle_report_query()`
- **格式**:
  - 单日: `2024-01-01`
  - 范围: `2024-01-01 2024-01-31`

### 开销查询输入 (`QUERY_EXPENSE_*`)
- **触发**: 在开销查询模式下输入日期
- **处理文件**: `handlers/message_handlers.py:_handle_expense_query()`
- **格式**: 同报表查询

### 开销输入 (`WAITING_EXPENSE_*`)
- **触发**: 在添加开销模式下输入金额和备注
- **处理文件**: `handlers/message_handlers.py:_handle_expense_input()`
- **格式**: `金额 备注`（如：`100 Server Cost`）

### 违约完成金额输入 (`WAITING_BREACH_END_AMOUNT`)
- **触发**: 在违约完成模式下输入金额
- **处理文件**: `handlers/message_handlers.py:_handle_breach_end_amount()`
- **格式**: 数字（如：`5000`）

### 群发消息输入 (`BROADCASTING`)
- **触发**: 在群发模式下输入消息内容
- **处理文件**: `handlers/message_handlers.py:_handle_broadcast()`
- **功能**: 向所有锁定的群组发送消息

---

## 权限说明

### 管理员权限
- 所有命令和操作
- 资金调整、归属ID管理、员工管理

### 授权员工权限
- 订单创建和管理
- 状态变更
- 金额操作（本金减少、利息收入）
- 查询和报表
- 搜索功能

### 权限检查位置
- `decorators.py`: `admin_required`, `authorized_required`
- `handlers/amount_handlers.py`: 金额操作的权限检查

---

## 使用场景限制

### 仅私聊
- `/start`, `/report`, `/search`
- 所有管理命令（`/adjust`, `/create_attribution` 等）

### 仅群组
- `/create`, `/order`
- 所有状态变更命令（`/normal`, `/overdue` 等）
- 快捷操作（`+金额`）

### 通用
- 回调按钮（根据上下文判断）

---

## 数据流说明

### 订单创建流程
1. 解析群名 → 提取订单信息
2. 检查余额（非历史订单）
3. 创建订单记录
4. 更新统计数据（Valid/Breach）
5. 扣除流动资金（非历史订单）
6. 更新客户统计（新/老客户）

### 状态变更流程
1. 验证当前状态
2. 更新订单状态
3. 移动统计数据（Valid ↔ Breach）
4. 更新流动资金（如完成订单）

### 金额操作流程
1. 验证权限和订单状态
2. 更新订单金额（如本金减少）
3. 更新统计数据
4. 更新流动资金

---

## 注意事项

1. **历史订单**: 2025-11-25之前的订单不扣款，仅导入数据
2. **日结时间**: 每天23:00为日切时间
3. **订单唯一性**: 每个群组只能有一个活跃订单
4. **状态限制**: 完成状态（`end`, `breach_end`）的订单不再更改
5. **金额验证**: 所有金额操作都会验证正数和上限



















